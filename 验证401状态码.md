# 验证 Token 过期返回 401

## ✅ 修改完成

**核心改动：**
1. ✅ 创建了 `TokenExpiredException` 自定义异常
2. ✅ `JwtUtil.java` - 捕获 JWT 过期异常，抛出自定义异常
3. ✅ `GlobalExceptionHandler.java` - 捕获异常，**返回 401**
4. ✅ 测试页面已更新，会显示 "返回状态码: 401 ✅"

---

## 🚀 快速验证（30 秒开始）

### 方法1：使用自动化测试页面

```bash
# 1. 重启后端
mvn spring-boot:run

# 2. 浏览器打开
test_token_expiration.html

# 3. 点击"开始自动测试"

# 4. 等待约 60 秒，观察日志显示：
#    "❌ Token 已过期！返回状态码: 401 ✅"
```

---

### 方法2：手动测试（最快！）

**步骤1：登录**
```bash
curl -X POST http://localhost:8080/user/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"123456"}'
```

**步骤2：复制 token，立即测试**
```bash
curl -X GET http://localhost:8080/user/info \
  -H "Authorization: 你的token"
```
**结果：** `{"code": 200, ...}` ✅

**步骤3：等待 60 秒**
```bash
sleep 60
```

**步骤4：再次测试**
```bash
curl -X GET http://localhost:8080/user/info \
  -H "Authorization: 你的token"
```
**结果：** `{"code": 401, "msg": "Token 已过期，请重新登录"}` ✅

---

## 📊 预期结果对比

### ✅ Token 有效时（0-59 秒）

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "data": {
      "id": 1,
      "phone": "13800138000",
      "nikeName": "测试用户"
    }
  }
}
```

### ❌ Token 过期时（60 秒后）

```json
{
  "code": 401,
  "msg": "Token 已过期，请重新登录",
  "data": null
}
```

**关键点：** `code: 401` ✅

---

## 🎯 验证要点

### 必须验证的 3 点：

1. **状态码是 401** ✅
   ```json
   "code": 401
   ```

2. **错误信息友好** ✅
   ```json
   "msg": "Token 已过期，请重新登录"
   ```

3. **时间准确** ✅
   - Token 应该在约 60 秒后过期
   - 不应该提前或延后太多

---

## 📋 快速检查清单

启动测试前：
- [ ] 已重启后端服务（必须！）
- [ ] Token 有效期已设为 60000（1分钟）
- [ ] 后端正常运行

执行测试：
- [ ] 登录成功
- [ ] 立即使用 token 返回 200
- [ ] 60 秒后使用 token 返回 **401**（不是 500！）
- [ ] 错误信息为 "Token 已过期，请重新登录"

---

## 💡 如何确认是 401？

### 在浏览器控制台查看

```javascript
fetch('http://localhost:8080/user/info', {
    headers: { 'Authorization': '过期的token' }
})
.then(res => res.json())
.then(data => {
    console.log('状态码:', data.code);  // 应该是 401
    console.log('错误信息:', data.msg);  // "Token 已过期，请重新登录"
});
```

### 使用 curl 查看

```bash
curl -s -X GET http://localhost:8080/user/info \
  -H "Authorization: 过期的token" \
  | grep -o '"code":[0-9]*'
```

**输出：** `"code":401` ✅

---

## 🎉 成功标志

当你看到以下任一情况，说明修改成功：

✅ **测试页面日志显示：**
```
❌ Token 已过期！返回状态码: 401 ✅
   错误信息: Token 已过期，请重新登录
🎉 测试成功！Token 在约 60 秒后过期
✅ 返回正确的 401 状态码
```

✅ **curl 响应显示：**
```json
{"code":401,"msg":"Token 已过期，请重新登录","data":null}
```

✅ **HTTP 测试文件响应：**
```json
{
  "code": 401,
  "msg": "Token 已过期，请重新登录",
  "data": null
}
```

---

## 🔄 测试完成后

**恢复正常有效期：**

编辑 `application.properties`：
```properties
jwt.expiration=3600000  # 改回 1 小时
```

**重启服务！**

---

## 🎊 立即验证

**最简单的验证方式：**

1. **重启后端** → `mvn spring-boot:run`
2. **打开测试页面** → `test_token_expiration.html`
3. **点击"开始自动测试"**
4. **等待 60 秒**
5. **查看日志** → 应该显示 "返回状态码: 401 ✅"

就这么简单！🚀

