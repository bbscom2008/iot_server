# IoTæœåŠ¡å™¨æ–°æœåŠ¡å™¨éƒ¨ç½²æ•™ç¨‹

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

### 1. æœåŠ¡å™¨ç¯å¢ƒè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: CentOS 7+ / Ubuntu 18.04+ / Windows Server 2016+
- **Javaç‰ˆæœ¬**: JDK 8 æˆ– JDK 11
- **å†…å­˜**: æœ€å°‘2GBï¼Œæ¨è4GB+
- **ç£ç›˜ç©ºé—´**: æœ€å°‘10GBå¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: ç¡®ä¿æœåŠ¡å™¨å¯ä»¥è®¿é—®å¤–ç½‘ï¼ˆç”¨äºä¸‹è½½ä¾èµ–ï¼‰

### 2. æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
```bash
# æ£€æŸ¥Javaç‰ˆæœ¬
java -version

# æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
free -h

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping www.baidu.com
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ é¡¹ç›®æ–‡ä»¶

#### æ–¹æ³•1ï¼šä½¿ç”¨SCPä¸Šä¼ ï¼ˆæ¨èï¼‰
```bash
# åœ¨æœ¬åœ°æ‰§è¡Œï¼Œå°†é¡¹ç›®ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp -r iot_server/ root@æœåŠ¡å™¨IP:/opt/

# æˆ–è€…åªä¸Šä¼ jaråŒ…
scp target/demo-0.0.1-SNAPSHOT.jar root@æœåŠ¡å™¨IP:/opt/iot_server/
```

#### æ–¹æ³•2ï¼šä½¿ç”¨Gitå…‹éš†
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /opt
git clone ä½ çš„é¡¹ç›®ä»“åº“åœ°å€
cd iot_server
```

### ç¬¬äºŒæ­¥ï¼šå®‰è£…Javaç¯å¢ƒ

#### CentOS/RHELç³»ç»Ÿ
```bash
# å®‰è£…OpenJDK 8
yum install -y java-1.8.0-openjdk java-1.8.0-openjdk-devel

# æˆ–è€…å®‰è£…OpenJDK 11
yum install -y java-11-openjdk java-11-openjdk-devel

# è®¾ç½®JAVA_HOME
echo 'export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk' >> /etc/profile
echo 'export PATH=$JAVA_HOME/bin:$PATH' >> /etc/profile
source /etc/profile
```

#### Ubuntuç³»ç»Ÿ
```bash
# æ›´æ–°åŒ…åˆ—è¡¨
apt update

# å®‰è£…OpenJDK 8
apt install -y openjdk-8-jdk

# æˆ–è€…å®‰è£…OpenJDK 11
apt install -y openjdk-11-jdk

# è®¾ç½®é»˜è®¤Javaç‰ˆæœ¬
update-alternatives --config java
```

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®æ•°æ®åº“

#### å®‰è£…MySQL
```bash
# CentOSç³»ç»Ÿ
yum install -y mysql-server mysql
systemctl start mysqld
systemctl enable mysqld

# Ubuntuç³»ç»Ÿ
apt install -y mysql-server mysql-client
systemctl start mysql
systemctl enable mysql
```

#### åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
```bash
# ç™»å½•MySQL
mysql -u root -p

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE iot_database CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# åˆ›å»ºç”¨æˆ·
CREATE USER 'iot_user'@'localhost' IDENTIFIED BY 'your_password';
CREATE USER 'iot_user'@'%' IDENTIFIED BY 'your_password';

# æˆæƒ
GRANT ALL PRIVILEGES ON iot_database.* TO 'iot_user'@'localhost';
GRANT ALL PRIVILEGES ON iot_database.* TO 'iot_user'@'%';
FLUSH PRIVILEGES;

# é€€å‡º
EXIT;
```

#### å¯¼å…¥æ•°æ®åº“ç»“æ„
```bash
# å¯¼å…¥SQLæ–‡ä»¶
mysql -u iot_user -p iot_database < iot_database_init.sql
```

### ç¬¬å››æ­¥ï¼šé…ç½®åº”ç”¨

#### ä¿®æ”¹é…ç½®æ–‡ä»¶
```bash
# ç¼–è¾‘ç”Ÿäº§ç¯å¢ƒé…ç½®
nano src/main/resources/application-prod.properties
```

é…ç½®å†…å®¹ï¼š
```properties
# æ•°æ®åº“é…ç½®
spring.datasource.url=jdbc:mysql://localhost:3306/iot_database?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
spring.datasource.username=iot_user
spring.datasource.password=your_password
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# æœåŠ¡å™¨ç«¯å£
server.port=8080

# æ—¥å¿—é…ç½®
logging.level.com.example.demo=INFO
logging.file.name=/opt/iot_server/logs/iot-app.log

# JPAé…ç½®
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect
```

### ç¬¬äº”æ­¥ï¼šç¼–è¯‘å’Œæ‰“åŒ…

#### ä½¿ç”¨Mavenç¼–è¯‘
```bash
cd /opt/iot_server

# æ¸…ç†å¹¶ç¼–è¯‘
mvn clean compile

# è¿è¡Œæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
mvn test

# æ‰“åŒ…
mvn package -DskipTests
```

#### éªŒè¯jaråŒ…
```bash
# æ£€æŸ¥jaråŒ…æ˜¯å¦ç”Ÿæˆ
ls -la target/demo-0.0.1-SNAPSHOT.jar

# æŸ¥çœ‹jaråŒ…å†…å®¹
jar -tf target/demo-0.0.1-SNAPSHOT.jar | head -20
```

### ç¬¬å…­æ­¥ï¼šåˆ›å»ºç³»ç»ŸæœåŠ¡

#### åˆ›å»ºæœåŠ¡æ–‡ä»¶
```bash
# åˆ›å»ºæœåŠ¡é…ç½®æ–‡ä»¶
nano /etc/systemd/system/iot-app.service
```

æœåŠ¡é…ç½®å†…å®¹ï¼š
```ini
[Unit]
Description=IoT Application
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/iot_server
ExecStart=/usr/bin/java -jar -Dspring.profiles.active=prod target/demo-0.0.1-SNAPSHOT.jar
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

# JVMå‚æ•°
Environment=JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC"

[Install]
WantedBy=multi-user.target
```

#### å¯åŠ¨æœåŠ¡
```bash
# é‡æ–°åŠ è½½systemdé…ç½®
systemctl daemon-reload

# å¯ç”¨æœåŠ¡
systemctl enable iot-app

# å¯åŠ¨æœåŠ¡
systemctl start iot-app

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status iot-app

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
journalctl -u iot-app -f
```

### ç¬¬ä¸ƒæ­¥ï¼šé…ç½®é˜²ç«å¢™

#### CentOS/RHELç³»ç»Ÿ
```bash
# å¼€æ”¾8080ç«¯å£
firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --reload

# æŸ¥çœ‹å¼€æ”¾çš„ç«¯å£
firewall-cmd --list-ports
```

#### Ubuntuç³»ç»Ÿ
```bash
# å¼€æ”¾8080ç«¯å£
ufw allow 8080/tcp

# å¯ç”¨é˜²ç«å¢™
ufw enable

# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
ufw status
```

### ç¬¬å…«æ­¥ï¼šé…ç½®Nginxåå‘ä»£ç†ï¼ˆå¯é€‰ï¼‰

#### å®‰è£…Nginx
```bash
# CentOSç³»ç»Ÿ
yum install -y nginx

# Ubuntuç³»ç»Ÿ
apt install -y nginx
```

#### é…ç½®Nginx
```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶
nano /etc/nginx/conf.d/iot-server.conf
```

Nginxé…ç½®å†…å®¹ï¼š
```nginx
server {
    listen 80;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºä½ çš„åŸŸåæˆ–IP

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # é™æ€æ–‡ä»¶ç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### å¯åŠ¨Nginx
```bash
# æµ‹è¯•é…ç½®
nginx -t

# å¯åŠ¨Nginx
systemctl start nginx
systemctl enable nginx

# é‡æ–°åŠ è½½é…ç½®
systemctl reload nginx
```

## ğŸ”§ éƒ¨ç½²åéªŒè¯

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æ£€æŸ¥Javaè¿›ç¨‹
ps aux | grep java

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep 8080

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status iot-app
```

### 2. æµ‹è¯•APIæ¥å£
```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8080/actuator/health

# æµ‹è¯•ç”¨æˆ·æ³¨å†Œæ¥å£
curl -X POST http://localhost:8080/api/users/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"123456","email":"test@example.com"}'

# æµ‹è¯•ç™»å½•æ¥å£
curl -X POST http://localhost:8080/api/users/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"123456"}'
```

### 3. æ£€æŸ¥æ—¥å¿—
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f /opt/iot_server/logs/iot-app.log

# æŸ¥çœ‹ç³»ç»ŸæœåŠ¡æ—¥å¿—
journalctl -u iot-app --since "1 hour ago"
```

## ğŸ› ï¸ å¸¸è§é—®é¢˜è§£å†³

### é—®é¢˜1ï¼šJavaè¿›ç¨‹å¯åŠ¨å¤±è´¥
```bash
# æ£€æŸ¥Javaç‰ˆæœ¬
java -version

# æ£€æŸ¥jaråŒ…å®Œæ•´æ€§
file target/demo-0.0.1-SNAPSHOT.jar

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 8080
```

### é—®é¢˜2ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€
systemctl status mysql

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
mysql -u iot_user -p -h localhost iot_database

# æ£€æŸ¥é˜²ç«å¢™
firewall-cmd --list-all
```

### é—®é¢˜3ï¼šå†…å­˜ä¸è¶³
```bash
# æ£€æŸ¥å†…å­˜ä½¿ç”¨
free -h

# è°ƒæ•´JVMå‚æ•°
# ç¼–è¾‘æœåŠ¡æ–‡ä»¶
nano /etc/systemd/system/iot-app.service
# ä¿®æ”¹JAVA_OPTS="-Xms256m -Xmx512m"
```

### é—®é¢˜4ï¼šç«¯å£è¢«å ç”¨
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :8080

# æ€æ­»è¿›ç¨‹
kill -9 PID

# æˆ–è€…ä¿®æ”¹åº”ç”¨ç«¯å£
nano src/main/resources/application-prod.properties
# ä¿®æ”¹server.port=8081
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### 1. è®¾ç½®æ—¥å¿—è½®è½¬
```bash
# åˆ›å»ºlogrotateé…ç½®
nano /etc/logrotate.d/iot-app
```

é…ç½®å†…å®¹ï¼š
```
/opt/iot_server/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 root root
    postrotate
        systemctl reload iot-app
    endscript
}
```

### 2. è®¾ç½®ç›‘æ§è„šæœ¬
```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
nano /opt/iot_server/monitor.sh
```

ç›‘æ§è„šæœ¬å†…å®¹ï¼š
```bash
#!/bin/bash

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
if ! systemctl is-active --quiet iot-app; then
    echo "$(date): IoTæœåŠ¡æœªè¿è¡Œï¼Œå°è¯•é‡å¯" >> /opt/iot_server/monitor.log
    systemctl restart iot-app
fi

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
MEMORY_USAGE=$(free | grep Mem | awk '{printf("%.2f"), $3/$2 * 100.0}')
if (( $(echo "$MEMORY_USAGE > 90" | bc -l) )); then
    echo "$(date): å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${MEMORY_USAGE}%" >> /opt/iot_server/monitor.log
fi

# æ£€æŸ¥ç£ç›˜ç©ºé—´
DISK_USAGE=$(df /opt | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 90 ]; then
    echo "$(date): ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${DISK_USAGE}%" >> /opt/iot_server/monitor.log
fi
```

```bash
# è®¾ç½®æ‰§è¡Œæƒé™
chmod +x /opt/iot_server/monitor.sh

# æ·»åŠ åˆ°crontab
crontab -e
# æ·»åŠ ï¼š*/5 * * * * /opt/iot_server/monitor.sh
```

## ğŸš€ å¿«é€Ÿéƒ¨ç½²è„šæœ¬

åˆ›å»ºä¸€é”®éƒ¨ç½²è„šæœ¬ï¼š
```bash
nano /opt/deploy-iot.sh
```

è„šæœ¬å†…å®¹ï¼š
```bash
#!/bin/bash

echo "å¼€å§‹éƒ¨ç½²IoTæœåŠ¡å™¨..."

# 1. æ£€æŸ¥Javaç¯å¢ƒ
if ! command -v java &> /dev/null; then
    echo "å®‰è£…Javaç¯å¢ƒ..."
    yum install -y java-1.8.0-openjdk java-1.8.0-openjdk-devel
fi

# 2. æ£€æŸ¥MySQL
if ! systemctl is-active --quiet mysql; then
    echo "å¯åŠ¨MySQLæœåŠ¡..."
    systemctl start mysql
    systemctl enable mysql
fi

# 3. ç¼–è¯‘é¡¹ç›®
echo "ç¼–è¯‘é¡¹ç›®..."
cd /opt/iot_server
mvn clean package -DskipTests

# 4. å¯åŠ¨æœåŠ¡
echo "å¯åŠ¨IoTæœåŠ¡..."
systemctl restart iot-app
systemctl enable iot-app

# 5. æ£€æŸ¥æœåŠ¡çŠ¶æ€
sleep 10
if systemctl is-active --quiet iot-app; then
    echo "âœ… IoTæœåŠ¡å™¨éƒ¨ç½²æˆåŠŸï¼"
    echo "è®¿é—®åœ°å€: http://æœåŠ¡å™¨IP:8080"
else
    echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
    journalctl -u iot-app --no-pager -l
fi
```

```bash
# è®¾ç½®æ‰§è¡Œæƒé™
chmod +x /opt/deploy-iot.sh

# æ‰§è¡Œéƒ¨ç½²
./deploy-iot.sh
```

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æœåŠ¡å™¨ç¯å¢ƒæ£€æŸ¥ï¼ˆJavaã€å†…å­˜ã€ç£ç›˜ï¼‰
- [ ] é¡¹ç›®æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨
- [ ] Javaç¯å¢ƒå®‰è£…å’Œé…ç½®
- [ ] MySQLæ•°æ®åº“å®‰è£…å’Œé…ç½®
- [ ] æ•°æ®åº“ç”¨æˆ·å’Œæƒé™è®¾ç½®
- [ ] åº”ç”¨é…ç½®æ–‡ä»¶ä¿®æ”¹
- [ ] é¡¹ç›®ç¼–è¯‘å’Œæ‰“åŒ…
- [ ] ç³»ç»ŸæœåŠ¡åˆ›å»ºå’Œå¯åŠ¨
- [ ] é˜²ç«å¢™ç«¯å£å¼€æ”¾
- [ ] Nginxåå‘ä»£ç†é…ç½®ï¼ˆå¯é€‰ï¼‰
- [ ] æœåŠ¡çŠ¶æ€éªŒè¯
- [ ] APIæ¥å£æµ‹è¯•
- [ ] æ—¥å¿—ç›‘æ§è®¾ç½®
- [ ] ç›‘æ§è„šæœ¬é…ç½®

## ğŸ¯ éƒ¨ç½²å®Œæˆ

éƒ¨ç½²å®Œæˆåï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®æœåŠ¡ï¼š

- **æœ¬åœ°è®¿é—®**: http://localhost:8080
- **è¿œç¨‹è®¿é—®**: http://æœåŠ¡å™¨IP:8080
- **åŸŸåè®¿é—®**: http://your-domain.comï¼ˆå¦‚æœé…ç½®äº†åŸŸåï¼‰

æœåŠ¡ç®¡ç†å‘½ä»¤ï¼š
```bash
# å¯åŠ¨æœåŠ¡
systemctl start iot-app

# åœæ­¢æœåŠ¡
systemctl stop iot-app

# é‡å¯æœåŠ¡
systemctl restart iot-app

# æŸ¥çœ‹çŠ¶æ€
systemctl status iot-app

# æŸ¥çœ‹æ—¥å¿—
journalctl -u iot-app -f
```

æ­å–œï¼IoTæœåŠ¡å™¨å·²æˆåŠŸéƒ¨ç½²åˆ°æ–°æœåŠ¡å™¨ä¸Šï¼ğŸ‰
