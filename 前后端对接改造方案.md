# UniApp前端对接 - 后端改造方案

## 📊 项目分析

### 当前后端项目
- **类型**：简单的用户管理系统
- **功能**：用户注册、登录、CRUD
- **认证方式**：用户名+密码

### UniApp前端项目
- **类型**：农牧物联网设备管理系统
- **主要功能**：
  - 用户登录（手机号+密码）
  - 设备管理（列表、详情、绑定、解绑）
  - 报警管理
  - 用户信息管理
- **API地址**：`https://app.nongmuiot.com/baomingxiang-app/`

---

## 🎯 需要实现的主要API

根据前端代码分析，需要实现以下接口：

### 1. 用户相关接口

| 接口路径 | 方法 | 功能 | 请求参数 | 响应数据 |
|---------|------|------|---------|---------|
| `/user/login` | POST | 用户登录 | `{phone, password}` | `{token, user}` |
| `/user/info` | GET | 获取用户信息 | - | `{data: userInfo}` |
| `/user/updateInfo` | POST | 更新用户信息 | `{nikeName, phone, address}` | - |

### 2. 设备相关接口

| 接口路径 | 方法 | 功能 | 请求参数 | 响应数据 |
|---------|------|------|---------|---------|
| `/device/list` | GET/POST | 获取设备列表 | `{pageNum, pageSize, search, type}` | `{list: [], total}` |
| `/device/statistics` | GET | 获取设备统计 | - | `{allDevice, lineDevice, warningDevice}` |
| `/device/detail` | GET | 获取设备详情 | `{deviceId}` | `{device}` |
| `/device/bind` | POST | 绑定设备 | `{deviceNum, deviceName}` | - |
| `/device/un/bind` | POST | 解绑设备 | `{deviceId}` | - |

### 3. 报警相关接口

| 接口路径 | 方法 | 功能 | 请求参数 | 响应数据 |
|---------|------|------|---------|---------|
| `/device/warning/list` | GET | 获取报警列表 | `{pageNum, pageSize}` | `{list: [], total}` |
| `/device/warning/read` | POST | 消除报警 | `{warningId}` | - |

---

## 🔧 改造步骤

### 步骤1：修改用户登录方式

**当前：** 用户名 + 密码  
**改为：** 手机号 + 密码

**需要修改：**
- `User` 实体类 - 添加 `phone`, `nikeName`, `address` 字段
- `LoginRequest` DTO - 将 `username` 改为 `phone`
- `UserMapper.xml` - 修改查询条件
- `UserService` - 修改登录逻辑
- `UserController` - 调整响应格式

### 步骤2：添加设备管理功能

**需要创建：**
1. `Device` 实体类
2. `DeviceMapper` 接口和 XML
3. `DeviceService` 服务类
4. `DeviceController` 控制器
5. 设备相关的 DTO 类

### 步骤3：添加报警管理功能

**需要创建：**
1. `DeviceWarning` 实体类
2. `WarningMapper` 接口和 XML
3. `WarningService` 服务类
4. `WarningController` 控制器

### 步骤4：统一响应格式

前端期望的响应格式需要调整：

**当前响应格式：**
```json
{
  "success": true,
  "message": "操作成功",
  "data": {...}
}
```

**可能需要的格式：**
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {...}
}
```

### 步骤5：添加Token认证

前端使用 `Authorization` 头部传递token，需要：
1. 添加 JWT 依赖
2. 创建 Token 工具类
3. 添加拦截器验证 token
4. 实现 `/my/` 路径的自动token验证

---

## 📁 需要创建的数据库表

### 1. users 表（需要修改）

```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    phone VARCHAR(20) NOT NULL UNIQUE COMMENT '手机号',
    password VARCHAR(255) NOT NULL COMMENT '密码',
    nike_name VARCHAR(50) COMMENT '昵称',
    address VARCHAR(255) COMMENT '地址',
    created_at DATETIME NOT NULL COMMENT '创建时间',
    updated_at DATETIME COMMENT '更新时间',
    INDEX idx_phone (phone)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 2. devices 表（新建）

```sql
CREATE TABLE devices (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    device_num VARCHAR(50) NOT NULL UNIQUE COMMENT '设备编号',
    device_name VARCHAR(100) COMMENT '设备名称',
    device_type INT COMMENT '设备类型：0-报警器 1-环控仪 2-变频器',
    breed_type INT COMMENT '养殖类型',
    device_line_state INT COMMENT '在线状态：0-离线 1-在线',
    signal INT COMMENT '信号强度',
    ta DECIMAL(5,2) COMMENT '温度A',
    tb DECIMAL(5,2) COMMENT '温度B',
    humidity DECIMAL(5,2) COMMENT '湿度',
    gas_con DECIMAL(10,2) COMMENT '气体浓度',
    warning_status INT DEFAULT 0 COMMENT '报警状态',
    outage_state INT DEFAULT 0 COMMENT '断电状态',
    created_at DATETIME NOT NULL COMMENT '创建时间',
    updated_at DATETIME COMMENT '更新时间',
    INDEX idx_user_id (user_id),
    INDEX idx_device_num (device_num)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备表';
```

### 3. device_warnings 表（新建）

```sql
CREATE TABLE device_warnings (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    device_id BIGINT NOT NULL COMMENT '设备ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    warning_type VARCHAR(50) COMMENT '报警类型',
    warning_msg TEXT COMMENT '报警信息',
    is_read INT DEFAULT 0 COMMENT '是否已读：0-未读 1-已读',
    created_at DATETIME NOT NULL COMMENT '创建时间',
    INDEX idx_device_id (device_id),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备报警表';
```

---

## 🚀 快速实施方案

考虑到改造工作量较大，建议采用以下方案：

### 方案A：完全重构（推荐，但工作量大）
1. 创建新的后端项目
2. 实现所有前端需要的接口
3. 完整的设备管理和报警功能

**优点：** 功能完整，架构清晰  
**缺点：** 开发周期长

### 方案B：渐进式改造（折中方案）
1. 先修改用户登录为手机号登录
2. 添加设备管理基础功能（增删改查）
3. 添加基础的报警功能
4. 逐步完善其他功能

**优点：** 快速上线，逐步完善  
**缺点：** 需要多次迭代

### 方案C：修改前端（最简单）
1. 修改前端的 API 地址指向现有后端
2. 调整前端代码适配现有 API
3. 隐藏设备管理相关功能

**优点：** 改动最小  
**缺点：** 功能受限

---

## 💡 我的建议

**如果你的目标是：**

### 🎯 目标1：快速演示用户管理功能
**方案：** 修改前端连接到当前后端
- 修改 `request.js` 中的 `BASE_URL`
- 调整登录页面使用用户名登录
- 隐藏设备管理功能

### 🎯 目标2：完整实现IoT系统
**方案：** 按照前端需求完整开发后端
- 创建所有数据库表
- 实现所有API接口
- 添加JWT认证
- 实现设备和报警管理

### 🎯 目标3：学习和测试
**方案：** 渐进式改造
- 先改造用户登录（手机号）
- 添加简单的设备列表功能
- 逐步完善

---

## 📝 下一步行动

请告诉我你的选择：

1. **我想完整实现IoT系统** → 我将帮你创建完整的后端代码
2. **我想快速适配用户管理** → 我将修改现有代码支持手机号登录
3. **我想修改前端连接当前后端** → 我将提供前端修改方案

请回复你的选择，我将继续为你实施！

