# æ³¨å†Œç™»å½•åŠŸèƒ½ - å®Œæ•´å®ç° âœ…

## ğŸ¯ å·²å®Œæˆçš„åŠŸèƒ½

æ ¹æ®å‰ç«¯ UniApp é¡¹ç›®çš„æ³¨å†Œé¡µé¢ï¼Œå·²å®Œæ•´å®ç°ï¼š

### âœ… ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½
- æ‰‹æœºå·æ³¨å†Œ
- éªŒè¯ç éªŒè¯
- å…»æ®–ç±»å‹é€‰æ‹©
- å²—ä½é€‰æ‹©

### âœ… éªŒè¯ç åŠŸèƒ½
- å‘é€éªŒè¯ç ï¼ˆæ¨¡æ‹Ÿï¼‰
- éªŒè¯ç éªŒè¯
- 60ç§’å€’è®¡æ—¶
- 5åˆ†é’Ÿæœ‰æ•ˆæœŸ

### âœ… ç”¨æˆ·ç™»å½•åŠŸèƒ½
- æ‰‹æœºå·å¯†ç ç™»å½•
- JWT Token è®¤è¯

---

## ğŸ“‹ æ–°å¢çš„å­—æ®µ

### User è¡¨æ–°å¢å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| `breeding_type` | VARCHAR(20) | å…»æ®–ç±»å‹ | å…»çŒªã€å…»é¸­ã€å…»é¸¡ã€å…»å…”ã€å…¶ä»– |
| `position` | VARCHAR(20) | å²—ä½ | è€æ¿ã€é¥²å…»å‘˜ã€å…¶ä»– |

---

## ğŸ”Œ API æ¥å£

### 1. å‘é€éªŒè¯ç 

**æ¥å£ï¼š** `POST /user/sendVerifyCode`

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "phone": "13800138000"
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "code": 200,
  "msg": "éªŒè¯ç å·²å‘é€",
  "data": null
}
```

**æ§åˆ¶å°ä¼šæ‰“å°éªŒè¯ç ï¼š**
```
==============================================
ã€æ¨¡æ‹ŸçŸ­ä¿¡ã€‘æ‰‹æœºå·: 13800138000
ã€éªŒè¯ç ã€‘: 123456
ã€æœ‰æ•ˆæœŸã€‘: 5åˆ†é’Ÿ
==============================================
```

**é”™è¯¯å“åº”ï¼š**
```json
{
  "code": 500,
  "msg": "è¯¥æ‰‹æœºå·å·²æ³¨å†Œ",
  "data": null
}
```

---

### 2. ç”¨æˆ·æ³¨å†Œ

**æ¥å£ï¼š** `POST /user/register`

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "phone": "13700137000",
  "password": "123456",
  "verifyCode": "123456",
  "breedingType": "å…»çŒª",
  "position": "è€æ¿"
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "code": 200,
  "msg": "æ³¨å†ŒæˆåŠŸ",
  "data": null
}
```

**é”™è¯¯å“åº”ï¼š**
```json
{
  "code": 500,
  "msg": "è¯¥æ‰‹æœºå·å·²æ³¨å†Œ",  // æˆ– "éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ"
  "data": null
}
```

---

### 3. ç”¨æˆ·ç™»å½•

**æ¥å£ï¼š** `POST /user/login`

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "phone": "13700137000",
  "password": "123456"
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "user": {
      "id": 3,
      "phone": "13700137000",
      "nikeName": "13700137000",
      "address": null,
      "icon": null
    }
  }
}
```

---

## ğŸ§ª å®Œæ•´æµ‹è¯•æµç¨‹

### æ­¥éª¤1ï¼šå‘é€éªŒè¯ç 

```bash
curl -X POST http://localhost:8080/user/sendVerifyCode \
  -H "Content-Type: application/json" \
  -d '{"phone":"13700137000"}'
```

**æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼Œè·å–éªŒè¯ç **ï¼ˆä¾‹å¦‚ï¼š123456ï¼‰

---

### æ­¥éª¤2ï¼šä½¿ç”¨éªŒè¯ç æ³¨å†Œ

```bash
curl -X POST http://localhost:8080/user/register \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13700137000",
    "password": "123456",
    "verifyCode": "123456",
    "breedingType": "å…»çŒª",
    "position": "è€æ¿"
  }'
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "code": 200,
  "msg": "æ³¨å†ŒæˆåŠŸ",
  "data": null
}
```

---

### æ­¥éª¤3ï¼šç™»å½•

```bash
curl -X POST http://localhost:8080/user/login \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13700137000",
    "password": "123456"
  }'
```

**é¢„æœŸå“åº”ï¼š** è¿”å› token å’Œç”¨æˆ·ä¿¡æ¯

---

## ğŸ“ HTTP æµ‹è¯•æ–‡ä»¶

åˆ›å»º `test_register.http`ï¼š

```http
### æ­¥éª¤1ï¼šå‘é€éªŒè¯ç 
POST http://localhost:8080/user/sendVerifyCode
Content-Type: application/json

{
  "phone": "13700137000"
}

###

### æ­¥éª¤2ï¼šæ³¨å†Œç”¨æˆ·ï¼ˆä½¿ç”¨ä¸Šé¢æ§åˆ¶å°æ‰“å°çš„éªŒè¯ç ï¼‰
POST http://localhost:8080/user/register
Content-Type: application/json

{
  "phone": "13700137000",
  "password": "123456",
  "verifyCode": "123456",
  "breedingType": "å…»çŒª",
  "position": "è€æ¿"
}

###

### æ­¥éª¤3ï¼šç™»å½•
POST http://localhost:8080/user/login
Content-Type: application/json

{
  "phone": "13700137000",
  "password": "123456"
}

###

### æµ‹è¯•é”™è¯¯ï¼šæ‰‹æœºå·å·²æ³¨å†Œ
POST http://localhost:8080/user/register
Content-Type: application/json

{
  "phone": "13800138000",
  "password": "123456",
  "verifyCode": "123456",
  "breedingType": "å…»çŒª",
  "position": "è€æ¿"
}

###

### æµ‹è¯•é”™è¯¯ï¼šéªŒè¯ç é”™è¯¯
POST http://localhost:8080/user/register
Content-Type: application/json

{
  "phone": "13700137001",
  "password": "123456",
  "verifyCode": "999999",
  "breedingType": "å…»çŒª",
  "position": "è€æ¿"
}

###
```

---

## ğŸ”§ éªŒè¯ç æœºåˆ¶è¯´æ˜

### å½“å‰å®ç°ï¼ˆæ¨¡æ‹Ÿï¼‰

**ç‰¹ç‚¹ï¼š**
- âœ… éªŒè¯ç å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ˆConcurrentHashMapï¼‰
- âœ… 5åˆ†é’Ÿæœ‰æ•ˆæœŸ
- âœ… ä¸€æ¬¡æ€§ä½¿ç”¨ï¼ˆéªŒè¯åè‡ªåŠ¨åˆ é™¤ï¼‰
- âœ… æ§åˆ¶å°æ‰“å°éªŒè¯ç ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰

**é™åˆ¶ï¼š**
- âš ï¸ æœåŠ¡é‡å¯åéªŒè¯ç ä¸¢å¤±
- âš ï¸ ä¸æ”¯æŒé›†ç¾¤éƒ¨ç½²
- âš ï¸ ä¸å‘é€çœŸå®çŸ­ä¿¡

### ç”Ÿäº§ç¯å¢ƒæ”¹è¿›

**éœ€è¦é›†æˆçœŸå®çŸ­ä¿¡æœåŠ¡ï¼š**

#### 1. ä½¿ç”¨é˜¿é‡Œäº‘çŸ­ä¿¡

```xml
<!-- pom.xml æ·»åŠ ä¾èµ– -->
<dependency>
    <groupId>com.aliyun</groupId>
    <artifactId>dysmsapi20170525</artifactId>
    <version>2.0.24</version>
</dependency>
```

```java
// VerifyCodeService.java ä¿®æ”¹
public void sendVerifyCode(String phone) {
    String code = generateCode();
    
    // è°ƒç”¨é˜¿é‡Œäº‘çŸ­ä¿¡API
    SendSmsRequest request = new SendSmsRequest()
        .setPhoneNumbers(phone)
        .setSignName("ä½ çš„ç­¾å")
        .setTemplateCode("SMS_123456")
        .setTemplateParam("{\"code\":\"" + code + "\"}");
    
    client.sendSms(request);
    
    // ä¿å­˜éªŒè¯ç åˆ° Redis
    redisTemplate.opsForValue().set("verify:" + phone, code, 5, TimeUnit.MINUTES);
}
```

#### 2. ä½¿ç”¨ Redis å­˜å‚¨

```properties
# application.properties
spring.redis.host=localhost
spring.redis.port=6379
```

```java
@Autowired
private RedisTemplate<String, String> redisTemplate;

public void sendVerifyCode(String phone) {
    String code = generateCode();
    // ä¿å­˜åˆ° Redisï¼Œ5åˆ†é’Ÿè¿‡æœŸ
    redisTemplate.opsForValue().set("verify:" + phone, code, 5, TimeUnit.MINUTES);
}

public boolean verifyCode(String phone, String code) {
    String savedCode = redisTemplate.opsForValue().get("verify:" + phone);
    if (savedCode != null && savedCode.equals(code)) {
        redisTemplate.delete("verify:" + phone);
        return true;
    }
    return false;
}
```

---

## ğŸ“Š ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|------|----------|------|
| `User.java` | æ·»åŠ  breedingType, position å­—æ®µ | âœ… |
| `UserMapper.java` | æ·»åŠ  insert æ–¹æ³• | âœ… |
| `UserMapper.xml` | æ·»åŠ æ³¨å†Œ SQLï¼Œæ›´æ–° resultMap | âœ… |
| `RegisterRequest.java` | æ–°å»ºæ³¨å†Œè¯·æ±‚ DTO | âœ… |
| `SendVerifyCodeRequest.java` | æ–°å»ºéªŒè¯ç è¯·æ±‚ DTO | âœ… |
| `VerifyCodeService.java` | æ–°å»ºéªŒè¯ç æœåŠ¡ | âœ… |
| `UserService.java` | æ·»åŠ æ³¨å†Œå’ŒéªŒè¯ç æ–¹æ³• | âœ… |
| `UserController.java` | æ·»åŠ æ³¨å†Œå’ŒéªŒè¯ç æ¥å£ | âœ… |
| `iot_database_init.sql` | æ›´æ–°ç”¨æˆ·è¡¨ç»“æ„ | âœ… |

**æ€»è®¡ï¼š9 ä¸ªæ–‡ä»¶**

---

## ğŸ”„ æ›´æ–°æ•°æ®åº“

### å¦‚æœè¿˜æ²¡åˆ›å»ºæ•°æ®åº“

```bash
mysql -u root -p < iot_database_init.sql
```

### å¦‚æœæ•°æ®åº“å·²å­˜åœ¨

```sql
USE iot_system;

-- æ·»åŠ æ–°å­—æ®µ
ALTER TABLE users 
ADD COLUMN breeding_type VARCHAR(20) COMMENT 'å…»æ®–ç±»å‹ï¼šå…»çŒªã€å…»é¸­ã€å…»é¸¡ã€å…»å…”ã€å…¶ä»–' AFTER icon;

ALTER TABLE users 
ADD COLUMN position VARCHAR(20) COMMENT 'å²—ä½ï¼šè€æ¿ã€é¥²å…»å‘˜ã€å…¶ä»–' AFTER breeding_type;

-- ä¸ºç°æœ‰ç”¨æˆ·è®¾ç½®é»˜è®¤å€¼
UPDATE users SET breeding_type = 'å…»çŒª', position = 'è€æ¿' WHERE breeding_type IS NULL;
```

---

## ğŸš€ æµ‹è¯•æ³¨å†Œæµç¨‹

### 1. é‡å¯åç«¯æœåŠ¡

```bash
mvn spring-boot:run
```

### 2. å‘é€éªŒè¯ç 

```bash
curl -X POST http://localhost:8080/user/sendVerifyCode \
  -H "Content-Type: application/json" \
  -d '{"phone":"13700137000"}'
```

**æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼Œå¤åˆ¶éªŒè¯ç **

### 3. æ³¨å†Œç”¨æˆ·

```bash
curl -X POST http://localhost:8080/user/register \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13700137000",
    "password": "123456",
    "verifyCode": "åˆšæ‰çš„éªŒè¯ç ",
    "breedingType": "å…»çŒª",
    "position": "è€æ¿"
  }'
```

### 4. ç™»å½•æµ‹è¯•

```bash
curl -X POST http://localhost:8080/user/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13700137000","password":"123456"}'
```

---

## ğŸ“± å‰ç«¯å¯¹æ¥

å‰ç«¯ä»£ç å·²ç»å®Œå…¨åŒ¹é…ï¼Œåªéœ€ä¿®æ”¹ API åœ°å€ï¼š

**æ–‡ä»¶ï¼š** `C:\Users\Administrator\Desktop\server\dspace\src\utils\request.js`

```javascript
const BASE_URL = 'http://localhost:8080/'  // æ”¹ä¸ºä½ çš„åç«¯åœ°å€
```

**å‰ç«¯ä¼šè‡ªåŠ¨è°ƒç”¨ï¼š**
1. `POST /user/sendVerifyCode` - å‘é€éªŒè¯ç 
2. `POST /user/register` - ç”¨æˆ·æ³¨å†Œ
3. `POST /user/login` - ç”¨æˆ·ç™»å½•

---

## ğŸ¨ æ³¨å†Œè¡¨å•å­—æ®µå¯¹ç…§

| å‰ç«¯å­—æ®µ | åç«¯å­—æ®µ | è¯´æ˜ |
|---------|---------|------|
| `phone` | `phone` | æ‰‹æœºå· |
| `password` | `password` | å¯†ç  |
| `verifyCode` | `verifyCode` | éªŒè¯ç  |
| `breedingType` | `breedingType` | å…»æ®–ç±»å‹ï¼ˆå…»çŒª/å…»é¸­/å…»é¸¡/å…»å…”/å…¶ä»–ï¼‰ |
| `position` | `position` | å²—ä½ï¼ˆè€æ¿/é¥²å…»å‘˜/å…¶ä»–ï¼‰ |

å®Œå…¨åŒ¹é…ï¼âœ…

---

## âš ï¸ é‡è¦æç¤º

### éªŒè¯ç æ˜¯æ¨¡æ‹Ÿçš„

**å¼€å‘æµ‹è¯•ï¼š**
- è°ƒç”¨ `sendVerifyCode` æ¥å£
- **æŸ¥çœ‹åç«¯æ§åˆ¶å°**ï¼Œå¤åˆ¶æ‰“å°çš„éªŒè¯ç 
- ä½¿ç”¨éªŒè¯ç æ³¨å†Œ

**ç¤ºä¾‹è¾“å‡ºï¼š**
```
==============================================
ã€æ¨¡æ‹ŸçŸ­ä¿¡ã€‘æ‰‹æœºå·: 13700137000
ã€éªŒè¯ç ã€‘: 834521
ã€æœ‰æ•ˆæœŸã€‘: 5åˆ†é’Ÿ
==============================================
```

### ç”Ÿäº§ç¯å¢ƒéœ€è¦

1. **é›†æˆçœŸå®çŸ­ä¿¡æœåŠ¡**ï¼ˆé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰ï¼‰
2. **ä½¿ç”¨ Redis å­˜å‚¨éªŒè¯ç **ï¼ˆæ”¯æŒé›†ç¾¤ï¼‰
3. **æ·»åŠ å‘é€é¢‘ç‡é™åˆ¶**ï¼ˆé˜²æ­¢æ¶æ„è¯·æ±‚ï¼‰
4. **å¯†ç åŠ å¯†å­˜å‚¨**ï¼ˆBCryptï¼‰

---

## ğŸ‰ åŠŸèƒ½å®Œæˆï¼

ç°åœ¨åç«¯å®Œå…¨åŒ¹é…å‰ç«¯çš„æ³¨å†Œç™»å½•åŠŸèƒ½ï¼š

âœ… **æ³¨å†ŒåŠŸèƒ½** - æ‰‹æœºå· + éªŒè¯ç  + å…»æ®–ç±»å‹ + å²—ä½  
âœ… **éªŒè¯ç åŠŸèƒ½** - å‘é€ + éªŒè¯ + è¿‡æœŸæ£€æŸ¥  
âœ… **ç™»å½•åŠŸèƒ½** - æ‰‹æœºå· + å¯†ç  + JWT Token  
âœ… **å­—æ®µå®Œæ•´** - æ‰€æœ‰å‰ç«¯éœ€è¦çš„å­—æ®µéƒ½å·²æ·»åŠ   

**é‡å¯åç«¯ï¼Œç«‹å³æµ‹è¯•ï¼** ğŸš€

