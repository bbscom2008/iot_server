# 注册功能 - 快速测试指南

## ✅ 功能已完成

后端已完全适配前端 UniApp 的注册登录功能！

---

## 🚀 立即测试（3 步骤）

### 第一步：更新数据库

**如果数据库已存在：**
```bash
mysql -u root -p < update_users_table.sql
```

**如果是新数据库：**
```bash
mysql -u root -p < iot_database_init.sql
```

### 第二步：重启后端

```bash
mvn spring-boot:run
```

### 第三步：测试注册流程

#### 1. 发送验证码

```bash
curl -X POST http://localhost:8080/user/sendVerifyCode \
  -H "Content-Type: application/json" \
  -d '{"phone":"13700137000"}'
```

**查看后端控制台，会打印：**
```
==============================================
【模拟短信】手机号: 13700137000
【验证码】: 834521  ← 复制这个验证码
【有效期】: 5分钟
==============================================
```

#### 2. 使用验证码注册

```bash
curl -X POST http://localhost:8080/user/register \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13700137000",
    "password": "123456",
    "verifyCode": "834521",
    "breedingType": "养猪",
    "position": "老板"
  }'
```

**预期响应：**
```json
{
  "code": 200,
  "msg": "注册成功",
  "data": null
}
```

#### 3. 登录测试

```bash
curl -X POST http://localhost:8080/user/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13700137000","password":"123456"}'
```

**预期响应：**
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "token": "eyJhbGci...",
    "user": {
      "id": 3,
      "phone": "13700137000",
      "nikeName": "13700137000"
    }
  }
}
```

---

## 📋 新增接口

| 接口 | 路径 | 说明 |
|------|------|------|
| 发送验证码 | `POST /user/sendVerifyCode` | 发送6位数字验证码 |
| 用户注册 | `POST /user/register` | 验证码注册 |
| 用户登录 | `POST /user/login` | 手机号密码登录 |

---

## 🎯 注册字段说明

### 必填字段

| 字段 | 类型 | 说明 | 前端选项 |
|------|------|------|---------|
| `phone` | String | 手机号 | 输入框 |
| `password` | String | 密码 | 输入框 |
| `verifyCode` | String | 验证码 | 输入框 |
| `breedingType` | String | 养殖类型 | 养猪/养鸭/养鸡/养兔/其他 |
| `position` | String | 岗位 | 老板/饲养员/其他 |

---

## 🧪 使用 HTTP 文件测试

打开 `test_register.http` 文件：

### 测试流程

1. **执行第一个请求** - 发送验证码
2. **查看控制台** - 复制打印的验证码
3. **修改第二个请求** - 替换 verifyCode 为实际验证码
4. **执行第二个请求** - 注册用户
5. **执行第三个请求** - 登录验证

---

## 💡 验证码机制

### 当前实现（开发测试用）

**特点：**
- ✅ 验证码在后端控制台打印
- ✅ 5 分钟有效期
- ✅ 一次性使用
- ✅ 验证后自动删除

**使用流程：**
```
1. 前端调用发送验证码接口
   ↓
2. 后端生成验证码（6位数字）
   ↓
3. 后端控制台打印验证码（模拟短信）
   ↓
4. 开发者复制验证码
   ↓
5. 前端提交注册（携带验证码）
   ↓
6. 后端验证验证码
   ↓
7. 验证通过，创建用户
```

### 生产环境实现

需要集成真实短信服务，请参考 `注册登录功能说明.md` 中的生产环境改进部分。

---

## 📊 完整的用户数据

注册成功后，用户表包含：

```sql
mysql> SELECT * FROM users WHERE phone = '13700137000';

+----+-------------+----------+--------------+---------+------+---------------+----------+---------------------+
| id | phone       | password | nike_name    | address | icon | breeding_type | position | created_at          |
+----+-------------+----------+--------------+---------+------+---------------+----------+---------------------+
|  3 | 13700137000 | 123456   | 13700137000  | NULL    | NULL | 养猪          | 老板     | 2024-10-18 15:30:00 |
+----+-------------+----------+--------------+---------+------+---------------+----------+---------------------+
```

---

## 🎨 前端界面对应

### 注册页面字段

```
┌─────────────────────────────┐
│      注册账号                │
├─────────────────────────────┤
│ 🌾 [请选择养殖类型] ▼        │ → breedingType
│ 👤 [请选择岗位] ▼            │ → position
│ 📱 [请输入手机号]            │ → phone
│ 🔐 [请输入验证码] [获取验证码]│ → verifyCode
│ 🔒 [请输入密码]              │ → password
├─────────────────────────────┤
│        [注册]                │
│   已有账号？立即登录          │
└─────────────────────────────┘
```

---

## 🔄 常见测试场景

### 场景1：正常注册 ✅

1. 发送验证码到新手机号
2. 获取控制台打印的验证码
3. 提交注册信息
4. 注册成功

### 场景2：手机号已注册 ❌

```bash
curl -X POST http://localhost:8080/user/sendVerifyCode \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000"}'
```

**响应：**
```json
{
  "code": 500,
  "msg": "该手机号已注册",
  "data": null
}
```

### 场景3：验证码错误 ❌

使用错误的验证码注册：

**响应：**
```json
{
  "code": 500,
  "msg": "验证码错误或已过期",
  "data": null
}
```

### 场景4：验证码过期 ❌

发送验证码后等待 5 分钟，再使用：

**响应：**
```json
{
  "code": 500,
  "msg": "验证码错误或已过期",
  "data": null
}
```

---

## 🎉 测试完成标志

### 成功注册的标志

1. ✅ 发送验证码响应 200
2. ✅ 控制台打印验证码
3. ✅ 注册响应：`{"code":200,"msg":"注册成功"}`
4. ✅ 可以使用新账号登录
5. ✅ 登录返回 token

---

## 📝 快速验证命令

```bash
# 一键测试（复制粘贴）

echo "1. 发送验证码..."
curl -X POST http://localhost:8080/user/sendVerifyCode \
  -H "Content-Type: application/json" \
  -d '{"phone":"13700137000"}'

echo ""
echo "2. 查看控制台获取验证码，然后手动执行注册..."
echo ""
echo "curl -X POST http://localhost:8080/user/register \\"
echo "  -H 'Content-Type: application/json' \\"
echo "  -d '{\"phone\":\"13700137000\",\"password\":\"123456\",\"verifyCode\":\"你的验证码\",\"breedingType\":\"养猪\",\"position\":\"老板\"}'"
```

---

## 📚 相关文档

| 文档 | 说明 |
|------|------|
| `注册登录功能说明.md` | 完整功能说明 |
| `test_register.http` | HTTP 测试文件 |
| `update_users_table.sql` | 数据库更新脚本 |

---

## 🎊 完成！

后端注册登录功能已完全匹配前端需求：

✅ 手机号注册  
✅ 验证码验证  
✅ 养殖类型选择  
✅ 岗位选择  
✅ 完整的错误处理  

**立即测试注册功能吧！** 📱🚀

