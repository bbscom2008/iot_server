# ç™»å½•æ¥å£æµ‹è¯•æŒ‡å—

## é—®é¢˜å·²ä¿®å¤ âœ…

å·²å°†æ‰€æœ‰æ¥å£çš„ `Authorization` å¤´éƒ¨æ”¹ä¸º**å¯é€‰**ï¼ˆ`required = false`ï¼‰ï¼Œè¿™æ ·ï¼š

1. **ç™»å½•æ¥å£** - ä¸éœ€è¦ Authorizationï¼ˆæ­£å¸¸ï¼‰
2. **å…¶ä»–æ¥å£** - Authorization å¯é€‰ï¼Œå¦‚æœæ²¡æœ‰æä¾›ä¼šè¿”å›å‹å¥½çš„é”™è¯¯æ¶ˆæ¯

---

## æµ‹è¯•ç™»å½•æ¥å£

### æ–¹æ³•1ï¼šä½¿ç”¨ curlï¼ˆå‘½ä»¤è¡Œï¼‰

```bash
curl -X POST http://localhost:8080/user/login \
  -H "Content-Type: application/json" \
  -d "{\"phone\":\"13800138000\",\"password\":\"123456\"}"
```

### æ–¹æ³•2ï¼šä½¿ç”¨ Postman

**è¯·æ±‚é…ç½®ï¼š**
- **æ–¹æ³•**ï¼šPOST
- **URL**ï¼š`http://localhost:8080/user/login`
- **Headers**ï¼š
  ```
  Content-Type: application/json
  ```
- **Body**ï¼ˆé€‰æ‹© raw + JSONï¼‰ï¼š
  ```json
  {
    "phone": "13800138000",
    "password": "123456"
  }
  ```

### æ–¹æ³•3ï¼šä½¿ç”¨ HTTP æ–‡ä»¶ï¼ˆåœ¨IDEä¸­ï¼‰

åˆ›å»º `test_login.http` æ–‡ä»¶ï¼š

```http
### æµ‹è¯•ç™»å½•
POST http://localhost:8080/user/login
Content-Type: application/json

{
  "phone": "13800138000",
  "password": "123456"
}
```

---

## é¢„æœŸæˆåŠŸå“åº”

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxIiwicGhvbmUiOiIxMzgwMDEzODAwMCIsImlhdCI6MTcwOTU0MzIxMCwiZXhwIjoxNzEwMTQ4MDEwfQ.xxxx",
    "user": {
      "id": 1,
      "phone": "13800138000",
      "nikeName": "æµ‹è¯•ç”¨æˆ·",
      "address": "åŒ—äº¬å¸‚æœé˜³åŒº",
      "icon": null
    }
  }
}
```

---

## æµ‹è¯•å…¶ä»–æ¥å£ï¼ˆå¸¦ Tokenï¼‰

ç™»å½•æˆåŠŸåï¼Œå¤åˆ¶è¿”å›çš„ `token` å€¼ï¼Œç„¶åæµ‹è¯•å…¶ä»–æ¥å£ï¼š

### è·å–ç”¨æˆ·ä¿¡æ¯

```bash
curl -X GET http://localhost:8080/user/info \
  -H "Authorization: ä½ çš„tokenå€¼"
```

### è·å–è®¾å¤‡åˆ—è¡¨

```bash
curl -X GET "http://localhost:8080/device/list?pageNum=1&pageSize=10" \
  -H "Authorization: ä½ çš„tokenå€¼"
```

### è·å–è®¾å¤‡ç»Ÿè®¡

```bash
curl -X GET http://localhost:8080/device/statistics \
  -H "Authorization: ä½ çš„tokenå€¼"
```

---

## é”™è¯¯åœºæ™¯æµ‹è¯•

### 1. ä¸æä¾› Authorizationï¼ˆæœŸæœ›è¿”å›å‹å¥½é”™è¯¯ï¼‰

```bash
curl -X GET http://localhost:8080/user/info
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "code": 401,
  "msg": "è¯·å…ˆç™»å½•",
  "data": null
}
```

### 2. é”™è¯¯çš„å¯†ç 

```bash
curl -X POST http://localhost:8080/user/login \
  -H "Content-Type: application/json" \
  -d "{\"phone\":\"13800138000\",\"password\":\"é”™è¯¯å¯†ç \"}"
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "code": 500,
  "msg": "å¯†ç é”™è¯¯",
  "data": null
}
```

### 3. ä¸å­˜åœ¨çš„ç”¨æˆ·

```bash
curl -X POST http://localhost:8080/user/login \
  -H "Content-Type: application/json" \
  -d "{\"phone\":\"99999999999\",\"password\":\"123456\"}"
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "code": 500,
  "msg": "ç”¨æˆ·ä¸å­˜åœ¨",
  "data": null
}
```

---

## å®Œæ•´æµ‹è¯•æµç¨‹

### 1. å¯åŠ¨åç«¯
```bash
mvn spring-boot:run
```

### 2. æµ‹è¯•ç™»å½•
```bash
curl -X POST http://localhost:8080/user/login \
  -H "Content-Type: application/json" \
  -d "{\"phone\":\"13800138000\",\"password\":\"123456\"}"
```

### 3. å¤åˆ¶ Token

ä»è¿”å›ç»“æœä¸­å¤åˆ¶ token å€¼ï¼ˆä¸åŒ…æ‹¬å¼•å·ï¼‰

### 4. æµ‹è¯•å¸¦è®¤è¯çš„æ¥å£

```bash
# æ›¿æ¢ YOUR_TOKEN ä¸ºå®é™…çš„ token
TOKEN="YOUR_TOKEN"

# è·å–ç”¨æˆ·ä¿¡æ¯
curl -X GET http://localhost:8080/user/info \
  -H "Authorization: $TOKEN"

# è·å–è®¾å¤‡åˆ—è¡¨
curl -X GET http://localhost:8080/device/list \
  -H "Authorization: $TOKEN"

# è·å–è®¾å¤‡ç»Ÿè®¡
curl -X GET http://localhost:8080/device/statistics \
  -H "Authorization: $TOKEN"
```

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: ä»ç„¶æŠ¥é”™ "Required request header 'Authorization'"ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®ä¿å·²é‡å¯åç«¯æœåŠ¡
2. æ¸…é™¤ IDE ç¼“å­˜ï¼ˆå¦‚æœä½¿ç”¨ IDEï¼‰
3. æ£€æŸ¥æ˜¯å¦è°ƒç”¨äº†æ­£ç¡®çš„æ¥å£è·¯å¾„

### Q2: ç™»å½•æˆåŠŸä½†å…¶ä»–æ¥å£è¿”å› 401ï¼Ÿ

**å¯èƒ½åŸå› ï¼š**
1. Token æœªæ­£ç¡®ä¼ é€’
2. Token æ ¼å¼é”™è¯¯ï¼ˆä¸è¦åŠ å¼•å·ï¼‰
3. Token å·²è¿‡æœŸï¼ˆ7å¤©æœ‰æ•ˆæœŸï¼‰

**æ£€æŸ¥æ–¹æ³•ï¼š**
```bash
# æŸ¥çœ‹å®é™…å‘é€çš„è¯·æ±‚å¤´
curl -v -X GET http://localhost:8080/user/info \
  -H "Authorization: ä½ çš„token"
```

### Q3: Token åœ¨å“ªé‡Œä¼ é€’ï¼Ÿ

**æ­£ç¡®æ–¹å¼ï¼š**
- åœ¨ HTTP è¯·æ±‚å¤´ï¼ˆHeaderï¼‰ä¸­
- é”®åï¼š`Authorization`
- é”®å€¼ï¼štoken å­—ç¬¦ä¸²ï¼ˆä¸è¦åŠ  "Bearer " å‰ç¼€ï¼‰

**é”™è¯¯æ–¹å¼ï¼š**
- âŒ åœ¨ URL å‚æ•°ä¸­
- âŒ åœ¨è¯·æ±‚ä½“ä¸­
- âŒ åŠ  "Bearer " å‰ç¼€ï¼ˆæœ¬ç³»ç»Ÿä¸éœ€è¦ï¼‰

---

## æµ‹è¯•è´¦å·

| æ‰‹æœºå· | å¯†ç  | è¯´æ˜ |
|--------|------|------|
| 13800138000 | 123456 | æ‹¥æœ‰3ä¸ªè®¾å¤‡ |
| 13900139000 | 123456 | æ‹¥æœ‰1ä¸ªè®¾å¤‡ |

---

## å¿«é€ŸéªŒè¯è„šæœ¬

åˆ›å»º `test.sh` æ–‡ä»¶ï¼š

```bash
#!/bin/bash

echo "=== æµ‹è¯•ç™»å½• ==="
response=$(curl -s -X POST http://localhost:8080/user/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"123456"}')

echo "$response"

# æå– tokenï¼ˆéœ€è¦ jq å·¥å…·ï¼‰
# token=$(echo "$response" | jq -r '.data.token')
# echo "Token: $token"

# æµ‹è¯•å…¶ä»–æ¥å£
# curl -X GET http://localhost:8080/user/info -H "Authorization: $token"
```

---

## ä¿®å¤å†…å®¹æ€»ç»“

å·²ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- âœ… `UserController.java` - ç™»å½•ã€è·å–ä¿¡æ¯ã€æ›´æ–°ä¿¡æ¯
- âœ… `DeviceController.java` - è®¾å¤‡åˆ—è¡¨ã€ç»Ÿè®¡ã€è¯¦æƒ…ã€ç»‘å®šã€è§£ç»‘
- âœ… `DeviceWarningController.java` - æŠ¥è­¦åˆ—è¡¨ã€æ¶ˆé™¤æŠ¥è­¦

æ‰€æœ‰æ¥å£ç°åœ¨ï¼š
- Authorization å¤´éƒ¨éƒ½æ˜¯å¯é€‰çš„ï¼ˆ`required = false`ï¼‰
- å¦‚æœç¼ºå°‘ tokenï¼Œè¿”å›å‹å¥½é”™è¯¯ï¼š`{"code": 401, "msg": "è¯·å…ˆç™»å½•"}`
- ç™»å½•æ¥å£å®Œå…¨ä¸éœ€è¦ token

---

## ç«‹å³æµ‹è¯•

è¿è¡Œä»¥ä¸‹å‘½ä»¤æµ‹è¯•ç™»å½•ï¼š

```bash
curl -X POST http://localhost:8080/user/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"123456"}'
```

åº”è¯¥èƒ½çœ‹åˆ°åŒ…å« token çš„æˆåŠŸå“åº”ï¼ğŸ‰

