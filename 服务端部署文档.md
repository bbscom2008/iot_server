# IoT系统服务端部署文档

## 环境要求

### 必需软件

| 软件 | 版本要求 | 说明 |
|------|---------|------|
| Java | JDK 17+ | Spring Boot 3.x要求 |
| MySQL | 5.7+ 或 8.0+ | 数据库 |
| Maven | 3.6+ | 项目构建工具 |

### 推荐配置

**开发环境**：
- CPU: 2核心
- 内存: 4GB
- 硬盘: 10GB

**生产环境**：
- CPU: 4核心+
- 内存: 8GB+
- 硬盘: 50GB+

## 部署步骤

### 1. 安装Java环境

#### Windows

```powershell
# 下载并安装JDK 17
# 官网：https://www.oracle.com/java/technologies/downloads/

# 验证安装
java -version
# 应该显示：java version "17.x.x"

# 配置环境变量
# JAVA_HOME = C:\Program Files\Java\jdk-17
# Path 添加 %JAVA_HOME%\bin
```

#### Linux

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install openjdk-17-jdk

# CentOS/RHEL
sudo yum install java-17-openjdk-devel

# 验证
java -version
```

### 2. 安装MySQL数据库

#### Windows

```powershell
# 下载MySQL 8.0
# 官网：https://dev.mysql.com/downloads/mysql/

# 安装后配置
# 设置root密码
# 启动MySQL服务
```

#### Linux

```bash
# Ubuntu/Debian
sudo apt install mysql-server

# CentOS/RHEL
sudo yum install mysql-server

# 启动服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

### 3. 创建数据库

```bash
# 连接MySQL
mysql -u root -p

# 执行初始化脚本
source /path/to/iot_server/iot_database_init.sql
```

或者手动执行：

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS iot_system 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE iot_system;

-- 执行表结构和初始数据（见 iot_database_init.sql）
```

**重要**：执行字段更新脚本：

```bash
# 更新icon字段支持Base64
mysql -u root -p iot_system < update_icon_field.sql
```

### 4. 配置数据库连接

编辑 `src/main/resources/application.properties`：

```properties
# 数据库配置
spring.datasource.url=jdbc:mysql://localhost:3306/iot_system?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
spring.datasource.username=root
spring.datasource.password=你的数据库密码
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# MyBatis配置
mybatis.mapper-locations=classpath:mapper/*.xml
mybatis.type-aliases-package=com.example.demo.entity
mybatis.configuration.map-underscore-to-camel-case=true

# JWT配置
jwt.secret=your-secret-key-here-change-in-production
jwt.expiration=604800000

# 服务器端口
server.port=8080

# 日志配置
logging.level.com.example.demo=INFO
logging.level.org.springframework.web=INFO
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} - %msg%n
```

### 5. 构建项目

#### 开发模式运行

```bash
cd iot_server

# 使用Maven运行
mvn spring-boot:run
```

#### 生产环境打包

```bash
cd iot_server

# 清理并打包
mvn clean package

# 或跳过测试
mvn clean package -DskipTests

# 生成的jar包位置：
# target/demo-0.0.1-SNAPSHOT.jar
```

### 6. 运行应用

#### 开发环境

```bash
# 方式1：使用Maven
mvn spring-boot:run

# 方式2：使用jar包
java -jar target/demo-0.0.1-SNAPSHOT.jar
```

#### 生产环境

```bash
# 后台运行
nohup java -jar demo-0.0.1-SNAPSHOT.jar > app.log 2>&1 &

# 或使用systemd服务（推荐）
sudo systemctl start iot-app
```

### 7. 验证部署

```bash
# 检查服务是否启动
curl http://localhost:8080/

# 测试登录接口
curl -X POST http://localhost:8080/user/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"123456"}'
```

## 生产环境配置

### 1. 使用生产配置文件

创建 `application-prod.properties`：

```properties
# 生产环境数据库
spring.datasource.url=jdbc:mysql://your-db-host:3306/iot_system?useUnicode=true&characterEncoding=utf8&useSSL=true&serverTimezone=Asia/Shanghai
spring.datasource.username=prod_user
spring.datasource.password=strong_password_here

# JWT密钥（必须修改）
jwt.secret=production-secret-key-at-least-32-characters-long
jwt.expiration=604800000

# 日志级别
logging.level.com.example.demo=WARN
logging.level.org.springframework.web=WARN

# 日志文件
logging.file.name=/var/log/iot-app/app.log
logging.file.max-size=10MB
logging.file.max-history=30
```

启动时指定配置：

```bash
java -jar demo-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod
```

### 2. 配置systemd服务（Linux）

创建 `/etc/systemd/system/iot-app.service`：

```ini
[Unit]
Description=IoT Application
After=mysql.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/iot-app
ExecStart=/usr/bin/java -jar /opt/iot-app/demo-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

管理服务：

```bash
# 重载配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start iot-app

# 设置开机自启
sudo systemctl enable iot-app

# 查看状态
sudo systemctl status iot-app

# 查看日志
sudo journalctl -u iot-app -f
```

### 3. 配置Nginx反向代理

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL证书配置
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    # 反向代理到Spring Boot
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS配置（如果前后端分离）
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
        
        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    # 静态文件（如果有）
    location /static/ {
        alias /opt/iot-app/static/;
        expires 30d;
    }
}
```

重启Nginx：

```bash
sudo nginx -t
sudo systemctl reload nginx
```

## 数据库维护

### 备份数据库

```bash
# 完整备份
mysqldump -u root -p iot_system > iot_system_backup_$(date +%Y%m%d).sql

# 仅数据
mysqldump -u root -p --no-create-info iot_system > iot_system_data_$(date +%Y%m%d).sql

# 仅结构
mysqldump -u root -p --no-data iot_system > iot_system_structure.sql
```

### 定时备份（crontab）

```bash
# 编辑crontab
crontab -e

# 每天凌晨3点备份
0 3 * * * /usr/bin/mysqldump -u root -pYourPassword iot_system > /backup/iot_system_$(date +\%Y\%m\%d).sql
```

### 恢复数据库

```bash
mysql -u root -p iot_system < iot_system_backup_20251021.sql
```

## 监控和日志

### 查看应用日志

```bash
# 实时查看日志
tail -f /var/log/iot-app/app.log

# 查看最近100行
tail -n 100 /var/log/iot-app/app.log

# 搜索错误
grep "ERROR" /var/log/iot-app/app.log

# 查看systemd日志
sudo journalctl -u iot-app -f
```

### 监控内存和CPU

```bash
# 查看Java进程
jps -l

# 查看进程详情
ps aux | grep java

# 内存使用
jmap -heap <pid>

# 线程信息
jstack <pid>
```

### 数据库监控

```sql
-- 查看连接数
SHOW PROCESSLIST;

-- 查看表大小
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS "Size (MB)"
FROM information_schema.TABLES
WHERE table_schema = 'iot_system'
ORDER BY (data_length + index_length) DESC;

-- 查看慢查询
SHOW VARIABLES LIKE 'slow_query%';
```

## 性能优化

### 1. JVM参数优化

```bash
java -jar demo-0.0.1-SNAPSHOT.jar \
  -Xms512m \
  -Xmx2048m \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/var/log/iot-app/heapdump.hprof
```

参数说明：
- `-Xms512m`: 初始堆内存512MB
- `-Xmx2048m`: 最大堆内存2GB
- `-XX:+UseG1GC`: 使用G1垃圾回收器
- `-XX:MaxGCPauseMillis=200`: 最大GC暂停时间200ms

### 2. 数据库优化

```sql
-- 添加索引
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_devices_user_id ON devices(user_id);
CREATE INDEX idx_device_warnings_user_id ON device_warnings(user_id);

-- 优化配置（my.cnf）
[mysqld]
max_connections = 200
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
```

### 3. 连接池配置

在 `application.properties` 添加：

```properties
# HikariCP连接池配置
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.idle-timeout=600000
spring.datasource.hikari.max-lifetime=1800000
```

## 安全配置

### 1. 修改默认密码

```sql
-- 修改测试用户密码
UPDATE users SET password = 'new_strong_password' WHERE phone = '13800138000';
```

### 2. 启用验证码校验

在 `UserService.java` 中取消注释：

```java
// 启用验证码验证
boolean isCodeValid = verifyCodeService.verifyCode(phone, verifyCode);
if (!isCodeValid) {
    throw new RuntimeException("验证码错误或已过期");
}
```

### 3. 配置HTTPS

使用Let's Encrypt免费证书：

```bash
# 安装certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

### 4. 数据库安全

```sql
-- 创建专用数据库用户
CREATE USER 'iot_user'@'localhost' IDENTIFIED BY 'strong_password';
GRANT ALL PRIVILEGES ON iot_system.* TO 'iot_user'@'localhost';
FLUSH PRIVILEGES;

-- 删除测试数据
DELETE FROM users WHERE phone IN ('13800138000', '13900139000');
```

### 5. 修改JWT密钥

```properties
# 生产环境必须修改
jwt.secret=your-production-secret-key-at-least-32-characters-long-random-string
```

## 常见问题排查

### 1. 端口被占用

```bash
# Windows查看端口
netstat -ano | findstr :8080

# Linux查看端口
lsof -i :8080
netstat -tulpn | grep 8080

# 修改端口
# application.properties
server.port=8081
```

### 2. 数据库连接失败

**检查**：
- MySQL服务是否启动
- 数据库用户名密码是否正确
- 数据库是否存在
- 网络连接是否正常

**常见错误**：

```
Communications link failure
→ 检查MySQL服务是否启动

Access denied for user
→ 检查用户名密码

Unknown database
→ 执行数据库初始化脚本
```

### 3. 应用启动失败

查看日志：

```bash
# 查看启动日志
cat app.log

# 常见问题
# - 端口被占用 → 修改端口
# - 内存不足 → 调整JVM参数
# - 配置错误 → 检查application.properties
```

### 4. 接口返回401

**原因**：Token验证失败

**检查**：
- Token是否过期
- Token格式是否正确
- JWT密钥是否一致

### 5. 图片上传失败

**检查**：
- icon字段是否已更新为MEDIUMTEXT
- Base64大小是否超限

```sql
-- 检查字段类型
DESCRIBE users;

-- icon字段应该是 mediumtext
```

## 部署检查清单

### 部署前

- [ ] Java环境已安装
- [ ] MySQL已安装并启动
- [ ] 数据库已创建
- [ ] 初始化脚本已执行
- [ ] icon字段已更新
- [ ] application.properties已配置
- [ ] JWT密钥已修改

### 部署中

- [ ] 项目构建成功
- [ ] jar包生成
- [ ] 应用启动成功
- [ ] 没有错误日志

### 部署后

- [ ] 健康检查接口正常
- [ ] 登录接口正常
- [ ] 注册接口正常
- [ ] 数据库连接正常
- [ ] 验证码功能正常
- [ ] 所有接口响应正常

## 更新部署

### 更新流程

```bash
# 1. 备份数据库
mysqldump -u root -p iot_system > backup_before_update.sql

# 2. 停止服务
sudo systemctl stop iot-app

# 3. 备份旧版本
cp demo-0.0.1-SNAPSHOT.jar demo-0.0.1-SNAPSHOT.jar.bak

# 4. 上传新版本
# 将新的jar包上传到服务器

# 5. 执行数据库更新脚本（如果有）
mysql -u root -p iot_system < update_xxx.sql

# 6. 启动服务
sudo systemctl start iot-app

# 7. 验证
curl http://localhost:8080/user/login -X POST \
  -H "Content-Type: application/json" \
  -d '{"phone":"test","password":"test"}'

# 8. 查看日志
sudo journalctl -u iot-app -f
```

### 回滚方案

```bash
# 1. 停止服务
sudo systemctl stop iot-app

# 2. 恢复旧版本
cp demo-0.0.1-SNAPSHOT.jar.bak demo-0.0.1-SNAPSHOT.jar

# 3. 恢复数据库（如果需要）
mysql -u root -p iot_system < backup_before_update.sql

# 4. 启动服务
sudo systemctl start iot-app
```

## 维护命令

### 应用管理

```bash
# 启动
sudo systemctl start iot-app

# 停止
sudo systemctl stop iot-app

# 重启
sudo systemctl restart iot-app

# 查看状态
sudo systemctl status iot-app

# 查看日志
sudo journalctl -u iot-app -n 100 --no-pager
```

### 数据库管理

```bash
# 进入MySQL
mysql -u root -p

# 查看所有数据库
SHOW DATABASES;

# 使用数据库
USE iot_system;

# 查看所有表
SHOW TABLES;

# 查看表结构
DESCRIBE users;
```

## 监控告警

### 简单监控脚本

```bash
#!/bin/bash
# check_app.sh

# 检查应用是否运行
if ! curl -s http://localhost:8080/ > /dev/null; then
    echo "应用未响应，尝试重启"
    sudo systemctl restart iot-app
    
    # 发送告警（可选）
    # curl -X POST "https://your-alert-service.com/alert" \
    #   -d "message=IoT应用重启"
fi
```

定时执行：

```bash
# crontab -e
*/5 * * * * /path/to/check_app.sh
```

## 目录结构（生产环境建议）

```
/opt/iot-app/
├── demo-0.0.1-SNAPSHOT.jar          # 应用jar包
├── application-prod.properties      # 生产配置
├── logs/                            # 日志目录
│   ├── app.log                      # 应用日志
│   └── access.log                   # 访问日志
├── backup/                          # 备份目录
│   └── db_backup_20251021.sql
└── scripts/                         # 脚本目录
    ├── start.sh                     # 启动脚本
    ├── stop.sh                      # 停止脚本
    └── check_app.sh                 # 监控脚本
```

## 性能调优建议

### 1. 数据库调优

```sql
-- 定期优化表
OPTIMIZE TABLE users, devices, device_warnings;

-- 分析表
ANALYZE TABLE users, devices;

-- 查看慢查询
SELECT * FROM mysql.slow_log ORDER BY query_time DESC LIMIT 10;
```

### 2. 应用调优

```properties
# 连接池优化
spring.datasource.hikari.maximum-pool-size=30
spring.datasource.hikari.minimum-idle=10

# 缓存配置
spring.cache.type=caffeine
spring.cache.caffeine.spec=maximumSize=1000,expireAfterWrite=1h
```

### 3. 系统调优

```bash
# 增加文件描述符限制
ulimit -n 65535

# 在 /etc/security/limits.conf 添加
* soft nofile 65535
* hard nofile 65535
```

## 接口清单

### 用户相关

| 接口 | 方法 | 说明 | Token |
|------|------|------|-------|
| /user/register | POST | 注册 | ❌ |
| /user/login | POST | 密码登录 | ❌ |
| /user/loginByCode | POST | 验证码登录 | ❌ |
| /user/info | GET | 获取用户信息 | ✅ |
| /user/updateInfo | POST | 更新用户信息 | ✅ |
| /user/changePhone | POST | 修改手机号 | ✅ |
| /user/changePasswordByOld | POST | 通过原密码修改密码 | ✅ |
| /user/changePasswordByPhone | POST | 通过手机号修改密码 | ❌ |

### 验证码相关

| 接口 | 方法 | 说明 | Token |
|------|------|------|-------|
| /user/sendRegisterCode | POST | 注册验证码 | ❌ |
| /user/sendLoginCode | POST | 登录验证码 | ❌ |
| /user/sendChangePhoneCode | POST | 修改手机号验证码 | ❌ |
| /user/sendResetPasswordCode | POST | 重置密码验证码 | ❌ |

### 设备相关

| 接口 | 方法 | 说明 | Token |
|------|------|------|-------|
| /device/list | GET | 设备列表 | ✅ |
| /device/info/{id} | GET | 设备详情 | ✅ |
| /device/add | POST | 添加设备 | ✅ |
| /device/update | PUT | 更新设备 | ✅ |
| /device/delete/{id} | DELETE | 删除设备 | ✅ |

### 报警相关

| 接口 | 方法 | 说明 | Token |
|------|------|------|-------|
| /warning/list | GET | 报警列表 | ✅ |
| /warning/read/{id} | POST | 标记已读 | ✅ |

## 附录

### A. 环境变量配置

```bash
# Linux ~/.bashrc 或 /etc/profile
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
export PATH=$JAVA_HOME/bin:$PATH
export MAVEN_HOME=/opt/maven
export PATH=$MAVEN_HOME/bin:$PATH
```

### B. 防火墙配置

```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 8080/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload
```

### C. 启动脚本示例

```bash
#!/bin/bash
# start.sh

APP_NAME=demo-0.0.1-SNAPSHOT.jar
APP_DIR=/opt/iot-app
LOG_FILE=$APP_DIR/logs/app.log

cd $APP_DIR

# 检查是否已运行
if [ -f app.pid ]; then
    PID=$(cat app.pid)
    if ps -p $PID > /dev/null; then
        echo "应用已在运行 (PID: $PID)"
        exit 1
    fi
fi

# 启动应用
nohup java -jar $APP_NAME \
  --spring.profiles.active=prod \
  -Xms512m -Xmx2048m \
  > $LOG_FILE 2>&1 &

echo $! > app.pid
echo "应用已启动 (PID: $!)"
```

### D. 停止脚本示例

```bash
#!/bin/bash
# stop.sh

if [ -f app.pid ]; then
    PID=$(cat app.pid)
    kill $PID
    echo "已停止应用 (PID: $PID)"
    rm app.pid
else
    echo "应用未运行"
fi
```

## 技术支持

### 问题排查流程

1. 查看应用日志
2. 查看数据库日志
3. 检查网络连接
4. 验证配置文件
5. 重启服务测试

### 联系信息

- 项目路径: `C:\Users\Administrator\Desktop\server\iot_server`
- 配置文件: `src/main/resources/application.properties`
- 数据库脚本: `iot_database_init.sql`

---

**文档版本**: 1.0  
**更新时间**: 2025-10-21  
**适用版本**: demo-0.0.1-SNAPSHOT

