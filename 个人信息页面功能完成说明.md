# 个人信息页面功能完成说明

## 功能概述

实现了完整的个人信息管理页面，包括两大功能模块：
1. **修改基本信息**：昵称、养殖类型、岗位角色、头像
2. **修改手机号**：需要验证码验证

## 前端实现

### 文件位置
`dspace/src/pages/user/user.vue`

### 功能模块

#### 1. 修改基本信息

**字段说明**：
- **头像**：点击上传图片（当前为本地路径，可扩展为服务器上传）
- **昵称**：文本输入
- **养殖类型**：选择器（养猪、养羊、养牛、养鸡、养鸭、其他）
- **岗位角色**：选择器（老板、饲养员、其他）

**验证规则**：
- 所有字段必填
- 昵称不能为空
- 必须选择养殖类型和岗位角色

**保存逻辑**：
- 调用 `POST /user/updateInfo` 接口
- 更新成功后，同步更新本地存储的用户信息
- 提示保存成功

#### 2. 修改手机号

**字段说明**：
- **原手机号**：只读显示
- **新手机号**：输入框
- **验证码**：输入框 + 获取验证码按钮（60秒倒计时）

**验证规则**：
- 新手机号格式：`/^1[3-9]\d{9}$/`
- 新手机号不能与原手机号相同
- 验证码必填

**修改流程**：
1. 输入新手机号
2. 点击"获取验证码"，调用 `POST /user/sendChangePhoneCode`
3. 输入验证码
4. 点击"保存手机号"，调用 `POST /user/changePhone`
5. 修改成功后清除登录信息，跳转到登录页

### UI设计

- **整体风格**：深色主题（#080822背景）
- **配色**：紫色主题（#6A5ACD）
- **布局**：分两个section，每个section包含独立的表单容器
- **交互**：按钮点击有过渡效果，输入框获焦时边框高亮

## 后端实现

### 1. Service层新增方法

**文件**: `iot_server/src/main/java/com/example/demo/service/UserService.java`

#### updateUserInfo（完善）
```java
@Transactional
public void updateUserInfo(Long userId, User updateData)
```
**功能**：更新用户基本信息
**新增字段支持**：
- breedingType（养殖类型）
- role（岗位角色）
- icon（头像）
- nikeName（昵称）

#### sendChangePhoneCode
```java
public void sendChangePhoneCode(String newPhone)
```
**功能**：发送修改手机号验证码
**验证**：检查新手机号是否已被其他用户注册

#### changePhone
```java
@Transactional
public void changePhone(Long userId, String newPhone, String verifyCode)
```
**功能**：修改手机号
**验证**：
- 用户存在性
- 新旧手机号不能相同
- 新手机号未被其他用户使用
- 验证码正确（开发阶段暂不校验）

### 2. Controller层新增接口

**文件**: `iot_server/src/main/java/com/example/demo/controller/UserController.java`

#### 发送修改手机号验证码
```
POST /user/sendChangePhoneCode
```
**请求体**：
```json
{
  "phone": "13800138000"
}
```
**响应**：
```json
{
  "code": 200,
  "msg": "success",
  "data": "验证码已发送"
}
```

#### 修改手机号
```
POST /user/changePhone
```
**请求头**：`Authorization: <token>`

**请求体**：
```json
{
  "newPhone": "13800138000",
  "verifyCode": "123456"
}
```
**响应**：
```json
{
  "code": 200,
  "msg": "success",
  "data": "手机号修改成功"
}
```

### 3. DTO类

**新增文件**: `iot_server/src/main/java/com/example/demo/dto/ChangePhoneRequest.java`

```java
@Data
public class ChangePhoneRequest {
    @NotBlank(message = "新手机号不能为空")
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String newPhone;

    @NotBlank(message = "验证码不能为空")
    private String verifyCode;
}
```

### 4. Mapper XML更新

**文件**: `iot_server/src/main/resources/mapper/UserMapper.xml`

**updateUser** 新增支持字段：
- phone（手机号）
- breedingType（养殖类型）
- role（角色）

### 5. Request工具类优化

**文件**: `dspace/src/utils/request.js`

**优化点**：
- 重构白名单逻辑，使用数组方式管理不需要token的接口
- 代码更清晰、易维护

```javascript
const noTokenUrls = [
  'user/login', 
  'user/register', 
  'user/sendVerifyCode', 
  'user/sendRegisterCode', 
  'user/sendLoginCode', 
  'user/loginByCode'
];
```

## API接口清单

### 用户信息相关

| 接口 | 方法 | 说明 | 需要Token |
|------|------|------|-----------|
| `/user/info` | GET | 获取用户信息 | ✅ |
| `/user/updateInfo` | POST | 更新用户基本信息 | ✅ |
| `/user/sendChangePhoneCode` | POST | 发送修改手机号验证码 | ❌ |
| `/user/changePhone` | POST | 修改手机号 | ✅ |

### updateInfo请求示例

```json
{
  "nikeName": "张三",
  "icon": "http://example.com/avatar.jpg",
  "breedingType": 0,
  "role": 0
}
```

**字段说明**：
- `breedingType`: 0-猪, 1-羊, 2-牛, 3-鸡, 4-鸭, 5-其他
- `role`: 0-老板, 1-饲养员, 2-其他

## 测试步骤

### 1. 测试修改基本信息

1. 登录系统
2. 进入个人信息页面
3. 修改昵称（如：张三）
4. 选择养殖类型（如：养猪）
5. 选择岗位角色（如：老板）
6. 点击头像位置选择图片
7. 点击"保存基本信息"
8. ✅ 应该提示"保存成功"
9. 刷新页面，信息应该已更新

### 2. 测试修改手机号

1. 在个人信息页面向下滚动到"修改手机号"部分
2. 查看原手机号（只读）
3. 输入新手机号（如：13800138001）
4. 点击"获取验证码"
5. ✅ 按钮进入60秒倒计时
6. ✅ 后端控制台输出验证码
7. 输入验证码
8. 点击"保存手机号"
9. ✅ 提示"手机号修改成功，请重新登录"
10. ✅ 自动跳转到登录页，并自动填入新手机号

### 3. 测试验证规则

**基本信息验证**：
- 昵称为空 → 提示"请输入昵称"
- 未选择养殖类型 → 提示"请选择养殖类型"
- 未选择岗位角色 → 提示"请选择岗位角色"

**修改手机号验证**：
- 新手机号为空 → 提示"请输入新手机号"
- 新手机号格式错误 → 提示"请输入正确的手机号"
- 新手机号与原手机号相同 → 提示"新手机号不能与原手机号相同"
- 新手机号已被注册 → 提示"该手机号已被其他用户使用"
- 验证码为空 → 提示"请输入验证码"
- 验证码错误 → 提示"验证码错误或已过期"（开发阶段不校验）

## 安全说明

1. **验证码验证**：当前开发阶段，验证码验证被注释掉，生产环境需要启用
2. **Token验证**：所有需要登录的接口都需要携带Authorization头
3. **手机号唯一性**：修改手机号时会检查新手机号是否已被其他用户使用
4. **修改手机号后强制重新登录**：确保账号安全

## 待优化项

1. **头像上传**：
   - 当前仅支持本地路径
   - 需要实现文件上传接口
   - 建议使用OSS存储

2. **验证码校验**：
   - 生产环境需要启用验证码验证
   - 在 `UserService.changePhone()` 方法中取消注释

3. **密码加密**：
   - 当前密码明文存储
   - 建议使用BCrypt等加密算法

## 相关文件清单

### 前端文件
- `dspace/src/pages/user/user.vue` - 个人信息页面
- `dspace/src/utils/request.js` - HTTP请求工具（已优化）

### 后端文件
- `iot_server/src/main/java/com/example/demo/controller/UserController.java` - 控制器
- `iot_server/src/main/java/com/example/demo/service/UserService.java` - 业务逻辑
- `iot_server/src/main/java/com/example/demo/dto/ChangePhoneRequest.java` - 修改手机号DTO（新增）
- `iot_server/src/main/resources/mapper/UserMapper.xml` - 数据库映射

## 完成时间

2025-10-21

## 功能演示流程

1. **登录系统** → 进入主页
2. **点击"我的"** → 进入个人中心
3. **点击"个人信息"** → 进入个人信息页面
4. **修改基本信息** → 填写信息 → 保存成功
5. **修改手机号** → 获取验证码 → 输入验证码 → 保存成功 → 重新登录

