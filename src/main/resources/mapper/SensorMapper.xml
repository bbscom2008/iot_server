<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.demo.mapper.SensorMapper">

    <resultMap id="BaseResultMap" type="com.example.demo.entity.Sensor">
        <id column="id" property="id" />
        <result column="parent_id" property="parentId" />
        <result column="sensor_code" property="sensorCode" />
        <result column="sensor_type_id" property="sensorTypeId" />
        <result column="sensor_name" property="sensorName" />
        <result column="sensor_value" property="sensorValue" />
        <result column="adjust_value" property="adjustValue" />
        <result column="unit" property="unit" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
    </resultMap>
    
    <resultMap id="SensorListResultMap" type="com.example.demo.dto.SensorListDTO">
        <id column="id" property="id" />
        <result column="parent_id" property="parentId" />
        <result column="sensor_code" property="sensorCode" />
        <result column="sensor_type_id" property="sensorTypeId" />
        <result column="sensor_name" property="sensorName" />
        <result column="sensor_value" property="sensorValue" />
        <result column="adjust_value" property="adjustValue" />
        <result column="unit" property="unit" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
        <!-- 设备信息 -->
        <result column="device_name" property="deviceName" />
        <result column="device_num" property="deviceNum" />
        <!-- 用户信息 -->
        <result column="user_name" property="userName" />
        <result column="user_phone" property="userPhone" />
    </resultMap>

    <!-- 根据传感器编号查询传感器 -->
    <select id="findBySensorCode" resultMap="BaseResultMap">
        SELECT * FROM sensors
        WHERE sensor_code = #{sensorCode}
    </select>

    <!-- 分页查询传感器列表（关联设备和用户信息） -->
    <select id="findListWithDeviceAndUser" resultMap="SensorListResultMap">
        SELECT 
            s.*,
            d.device_name as device_name,
            d.device_num as device_num,
            u.nike_name as user_name,
            u.phone as user_phone
        FROM sensors s
        LEFT JOIN devices d ON s.parent_id = d.id
        LEFT JOIN users u ON d.user_id = u.id
        <where>
            <if test="deviceId != null">
                AND s.parent_id = #{deviceId}
            </if>
            <if test="deviceName != null and deviceName != ''">
                AND d.device_name LIKE CONCAT('%', #{deviceName}, '%')
            </if>
            <if test="deviceNum != null and deviceNum != ''">
                AND d.device_num LIKE CONCAT('%', #{deviceNum}, '%')
            </if>
            <if test="userName != null and userName != ''">
                AND u.nike_name LIKE CONCAT('%', #{userName}, '%')
            </if>
            <if test="userPhone != null and userPhone != ''">
                AND u.phone LIKE CONCAT('%', #{userPhone}, '%')
            </if>
            <if test="sensorName != null and sensorName != ''">
                AND s.sensor_name LIKE CONCAT('%', #{sensorName}, '%')
            </if>
            <if test="sensorCode != null and sensorCode != ''">
                AND s.sensor_code LIKE CONCAT('%', #{sensorCode}, '%')
            </if>
        </where>
        ORDER BY s.created_at DESC
        <if test="offset != null and pageSize != null">
            LIMIT #{offset}, #{pageSize}
        </if>
    </select>

    <!-- 查询传感器总数（关联设备和用户信息） -->
    <select id="countListWithDeviceAndUser" resultType="long">
        SELECT COUNT(*)
        FROM sensors s
        LEFT JOIN devices d ON s.parent_id = d.id
        LEFT JOIN users u ON d.user_id = u.id
        <where>
            <if test="deviceId != null">
                AND s.parent_id = #{deviceId}
            </if>
            <if test="deviceName != null and deviceName != ''">
                AND d.device_name LIKE CONCAT('%', #{deviceName}, '%')
            </if>
            <if test="deviceNum != null and deviceNum != ''">
                AND d.device_num LIKE CONCAT('%', #{deviceNum}, '%')
            </if>
            <if test="userName != null and userName != ''">
                AND u.nike_name LIKE CONCAT('%', #{userName}, '%')
            </if>
            <if test="userPhone != null and userPhone != ''">
                AND u.phone LIKE CONCAT('%', #{userPhone}, '%')
            </if>
            <if test="sensorName != null and sensorName != ''">
                AND s.sensor_name LIKE CONCAT('%', #{sensorName}, '%')
            </if>
            <if test="sensorCode != null and sensorCode != ''">
                AND s.sensor_code LIKE CONCAT('%', #{sensorCode}, '%')
            </if>
        </where>
    </select>

</mapper>