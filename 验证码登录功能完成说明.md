# 验证码登录功能完成说明

## 问题描述

前端登录时选择验证码登录，点击"获取验证码"按钮，后端返回"该手机号已注册"错误。

## 问题原因

原有的 `sendVerifyCode` 接口在发送验证码前会检查手机号是否已注册：
- 如果手机号已注册，就抛出"该手机号已注册"异常
- 这个逻辑适用于注册场景（要求手机号未注册）
- 但不适用于登录场景（要求手机号已注册）

## 解决方案

### 1. 后端修改

#### 1.1 区分注册和登录的验证码接口

**文件**: `iot_server/src/main/java/com/example/demo/service/UserService.java`

新增两个方法：
- `sendRegisterCode(String phone)` - 注册验证码，要求手机号未注册
- `sendLoginCode(String phone)` - 登录验证码，要求手机号已注册

```java
/**
 * 发送注册验证码（注册时使用）
 */
public void sendRegisterCode(String phone) {
    User existUser = userMapper.findByPhone(phone);
    if (existUser != null) {
        throw new RuntimeException("该手机号已注册");
    }
    verifyCodeService.sendVerifyCode(phone);
}

/**
 * 发送登录验证码（登录时使用）
 */
public void sendLoginCode(String phone) {
    User existUser = userMapper.findByPhone(phone);
    if (existUser == null) {
        throw new RuntimeException("该手机号未注册");
    }
    verifyCodeService.sendVerifyCode(phone);
}
```

#### 1.2 添加验证码登录方法

**文件**: `iot_server/src/main/java/com/example/demo/service/UserService.java`

```java
/**
 * 验证码登录
 */
public LoginResponse loginByCode(String phone, String verifyCode) {
    User user = userMapper.findByPhone(phone);
    if (user == null) {
        throw new RuntimeException("用户不存在");
    }
    
    boolean isCodeValid = verifyCodeService.verifyCode(phone, verifyCode);
    if (!isCodeValid) {
        throw new RuntimeException("验证码错误或已过期");
    }
    
    String token = jwtUtil.generateToken(user.getId(), user.getPhone());
    return new LoginResponse(token, LoginResponse.UserInfo.from(user));
}
```

#### 1.3 添加Controller接口

**文件**: `iot_server/src/main/java/com/example/demo/controller/UserController.java`

新增三个接口：
1. `POST /user/sendRegisterCode` - 发送注册验证码
2. `POST /user/sendLoginCode` - 发送登录验证码  
3. `POST /user/loginByCode` - 验证码登录

```java
@PostMapping("/sendRegisterCode")
public ApiResponse<String> sendRegisterCode(@Valid @RequestBody SendVerifyCodeRequest request) {
    userService.sendRegisterCode(request.getPhone());
    return ApiResponse.success("验证码已发送");
}

@PostMapping("/sendLoginCode")
public ApiResponse<String> sendLoginCode(@Valid @RequestBody SendVerifyCodeRequest request) {
    userService.sendLoginCode(request.getPhone());
    return ApiResponse.success("验证码已发送");
}

@PostMapping("/loginByCode")
public ApiResponse<LoginResponse> loginByCode(@Valid @RequestBody LoginByCodeRequest request) {
    LoginResponse response = userService.loginByCode(request.getPhone(), request.getVerifyCode());
    return ApiResponse.success(response);
}
```

#### 1.4 新增DTO类

**文件**: `iot_server/src/main/java/com/example/demo/dto/LoginByCodeRequest.java`

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class LoginByCodeRequest {
    @NotBlank(message = "手机号不能为空")
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String phone;

    @NotBlank(message = "验证码不能为空")
    private String verifyCode;
}
```

### 2. 前端修改

#### 2.1 登录页面

**文件**: `dspace/src/pages/login/login.vue`

- 修改获取验证码接口为 `user/sendLoginCode`
- 启用验证码登录功能，调用 `user/loginByCode` 接口

```javascript
// 发送验证码（登录用）
async sendVerifyCode() {
    // ... 验证逻辑
    await request.post('user/sendLoginCode', {
        phone: this.phone
    })
    // ...
}

// 验证码登录
try {
    const res = await request.post('user/loginByCode', {
        phone: this.phone,
        verifyCode: this.verifyCode
    })
    this.handleLoginSuccess(res)
} catch (err) {
    // 错误处理
}
```

#### 2.2 注册页面

**文件**: `dspace/src/pages/register/register.vue`

- 修改获取验证码接口为 `user/sendRegisterCode`

```javascript
// 发送验证码（注册用）
async sendVerifyCode() {
    // ... 验证逻辑
    await request.post('user/sendRegisterCode', {
        phone: this.phone
    })
    // ...
}
```

## API接口清单

### 验证码相关

| 接口 | 方法 | 说明 | 使用场景 |
|------|------|------|----------|
| `/user/sendRegisterCode` | POST | 发送注册验证码 | 注册页面 |
| `/user/sendLoginCode` | POST | 发送登录验证码 | 登录页面 |
| `/user/sendVerifyCode` | POST | 发送验证码（已废弃） | 兼容旧版本 |

### 登录相关

| 接口 | 方法 | 说明 |
|------|------|------|
| `/user/login` | POST | 密码登录 |
| `/user/loginByCode` | POST | 验证码登录 |

## 测试步骤

### 1. 测试注册流程

1. 打开注册页面
2. 输入手机号（未注册的）
3. 点击"获取验证码"
4. 应该成功发送验证码
5. 如果输入已注册的手机号，会提示"该手机号已注册"

### 2. 测试登录流程（验证码登录）

1. 打开登录页面
2. 切换到"验证码登录"
3. 输入手机号（已注册的）
4. 点击"获取验证码"
5. 应该成功发送验证码，控制台会显示验证码
6. 输入验证码
7. 点击"验证码登录"
8. 应该成功登录并跳转到主页
9. 如果输入未注册的手机号，会提示"该手机号未注册"

## 注意事项

1. **验证码有效期**：验证码有效期为5分钟
2. **验证码使用次数**：每个验证码只能使用一次
3. **开发环境**：当前验证码会在后端控制台输出，生产环境需要接入真实的短信服务
4. **兼容性**：保留了旧的 `/user/sendVerifyCode` 接口（已标记为 @Deprecated），默认行为与 `sendRegisterCode` 相同

## 相关文件清单

### 后端文件
- `iot_server/src/main/java/com/example/demo/controller/UserController.java`
- `iot_server/src/main/java/com/example/demo/service/UserService.java`
- `iot_server/src/main/java/com/example/demo/service/VerifyCodeService.java`
- `iot_server/src/main/java/com/example/demo/dto/LoginByCodeRequest.java` (新增)

### 前端文件
- `dspace/src/pages/login/login.vue`
- `dspace/src/pages/register/register.vue`

## 完成时间

2025-10-21

