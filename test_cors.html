<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS è·¨åŸŸæµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .description {
            color: #666;
            margin-bottom: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }

        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .info {
            padding: 15px;
            background: #d1ecf1;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #0c5460;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ CORS è·¨åŸŸæµ‹è¯•å·¥å…·</h1>
        <div class="description">
            æ­¤é¡µé¢ç”¨äºæµ‹è¯•åç«¯ API çš„ CORS è·¨åŸŸé…ç½®æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚<br>
            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æµ‹è¯•ä¸åŒçš„ API æ¥å£ã€‚
        </div>

        <div class="info">
            <strong>ğŸ“ å½“å‰æµ‹è¯•ç¯å¢ƒï¼š</strong><br>
            å‰ç«¯é¡µé¢ï¼š<code id="current-origin"></code><br>
            åç«¯ APIï¼š<code>http://localhost:8080</code>
        </div>

        <!-- æµ‹è¯•1ï¼šç™»å½•æ¥å£ -->
        <div class="test-section">
            <h2>âœ… æµ‹è¯•1ï¼šç™»å½•æ¥å£ï¼ˆæ— éœ€è®¤è¯ï¼‰</h2>
            <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            <div id="login-result" class="result" style="display: none;"></div>
        </div>

        <!-- æµ‹è¯•2ï¼šè·å–ç”¨æˆ·ä¿¡æ¯ -->
        <div class="test-section">
            <h2>ğŸ”’ æµ‹è¯•2ï¼šè·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦ Tokenï¼‰</h2>
            <button onclick="testUserInfo()">æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯</button>
            <div id="userinfo-result" class="result" style="display: none;"></div>
        </div>

        <!-- æµ‹è¯•3ï¼šè·å–è®¾å¤‡åˆ—è¡¨ -->
        <div class="test-section">
            <h2>ğŸ“± æµ‹è¯•3ï¼šè·å–è®¾å¤‡åˆ—è¡¨ï¼ˆéœ€è¦ Tokenï¼‰</h2>
            <button onclick="testDeviceList()">æµ‹è¯•è·å–è®¾å¤‡åˆ—è¡¨</button>
            <div id="devicelist-result" class="result" style="display: none;"></div>
        </div>

        <!-- æµ‹è¯•4ï¼šOPTIONS é¢„æ£€è¯·æ±‚ -->
        <div class="test-section">
            <h2>ğŸ” æµ‹è¯•4ï¼šOPTIONS é¢„æ£€è¯·æ±‚</h2>
            <button onclick="testPreflight()">æµ‹è¯•é¢„æ£€è¯·æ±‚</button>
            <div id="preflight-result" class="result" style="display: none;"></div>
        </div>

        <!-- å…¨éƒ¨æµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸš€ ä¸€é”®æµ‹è¯•æ‰€æœ‰æ¥å£</h2>
            <button onclick="testAll()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                è¿è¡Œæ‰€æœ‰æµ‹è¯•
            </button>
        </div>
    </div>

    <script>
        // æ˜¾ç¤ºå½“å‰é¡µé¢çš„ origin
        document.getElementById('current-origin').textContent = window.location.origin;

        // å…¨å±€å˜é‡å­˜å‚¨ token
        let token = '';

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = message;
            element.className = 'result ' + (isSuccess ? 'success' : 'error');
        }

        // æµ‹è¯•1ï¼šç™»å½•
        async function testLogin() {
            try {
                const response = await fetch('http://localhost:8080/user/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: '13800138000',
                        password: '123456'
                    })
                });

                const data = await response.json();
                
                if (data.code === 200 && data.data.token) {
                    token = data.data.token;
                    showResult('login-result', 
                        `âœ… ç™»å½•æˆåŠŸï¼\n\n` +
                        `Token: ${token.substring(0, 50)}...\n\n` +
                        `ç”¨æˆ·ä¿¡æ¯:\n` +
                        JSON.stringify(data.data.user, null, 2), 
                        true);
                } else {
                    showResult('login-result', `âŒ ç™»å½•å¤±è´¥ï¼š\n${JSON.stringify(data, null, 2)}`, false);
                }
            } catch (error) {
                showResult('login-result', 
                    `âŒ CORS é”™è¯¯æˆ–ç½‘ç»œé”™è¯¯ï¼š\n${error.message}\n\n` +
                    `å¯èƒ½çš„åŸå› ï¼š\n` +
                    `1. åç«¯æœåŠ¡æœªå¯åŠ¨\n` +
                    `2. CORS é…ç½®æœ‰é—®é¢˜\n` +
                    `3. ç½‘ç»œè¿æ¥é—®é¢˜`, 
                    false);
            }
        }

        // æµ‹è¯•2ï¼šè·å–ç”¨æˆ·ä¿¡æ¯
        async function testUserInfo() {
            if (!token) {
                showResult('userinfo-result', 'âš ï¸ è¯·å…ˆæ‰§è¡Œç™»å½•æµ‹è¯•è·å– Token', false);
                return;
            }

            try {
                const response = await fetch('http://localhost:8080/user/info', {
                    method: 'GET',
                    headers: {
                        'Authorization': token
                    }
                });

                const data = await response.json();
                
                if (data.code === 200) {
                    showResult('userinfo-result', 
                        `âœ… è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸï¼\n\n` +
                        JSON.stringify(data, null, 2), 
                        true);
                } else {
                    showResult('userinfo-result', `âŒ è¯·æ±‚å¤±è´¥ï¼š\n${JSON.stringify(data, null, 2)}`, false);
                }
            } catch (error) {
                showResult('userinfo-result', 
                    `âŒ CORS é”™è¯¯æˆ–ç½‘ç»œé”™è¯¯ï¼š\n${error.message}\n\n` +
                    `Authorization å¤´éƒ¨å¯èƒ½è¢« CORS é˜»æ­¢`, 
                    false);
            }
        }

        // æµ‹è¯•3ï¼šè·å–è®¾å¤‡åˆ—è¡¨
        async function testDeviceList() {
            if (!token) {
                showResult('devicelist-result', 'âš ï¸ è¯·å…ˆæ‰§è¡Œç™»å½•æµ‹è¯•è·å– Token', false);
                return;
            }

            try {
                const response = await fetch('http://localhost:8080/device/list?pageNum=1&pageSize=10', {
                    method: 'GET',
                    headers: {
                        'Authorization': token
                    }
                });

                const data = await response.json();
                
                if (data.code === 200) {
                    showResult('devicelist-result', 
                        `âœ… è·å–è®¾å¤‡åˆ—è¡¨æˆåŠŸï¼\n\n` +
                        `è®¾å¤‡æ€»æ•°: ${data.data.total}\n\n` +
                        JSON.stringify(data.data.list, null, 2), 
                        true);
                } else {
                    showResult('devicelist-result', `âŒ è¯·æ±‚å¤±è´¥ï¼š\n${JSON.stringify(data, null, 2)}`, false);
                }
            } catch (error) {
                showResult('devicelist-result', 
                    `âŒ CORS é”™è¯¯æˆ–ç½‘ç»œé”™è¯¯ï¼š\n${error.message}`, 
                    false);
            }
        }

        // æµ‹è¯•4ï¼šOPTIONS é¢„æ£€è¯·æ±‚
        async function testPreflight() {
            try {
                const response = await fetch('http://localhost:8080/user/info', {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'Authorization'
                    }
                });

                const headers = {};
                response.headers.forEach((value, key) => {
                    if (key.toLowerCase().includes('access-control')) {
                        headers[key] = value;
                    }
                });

                showResult('preflight-result', 
                    `âœ… OPTIONS é¢„æ£€è¯·æ±‚æˆåŠŸï¼\n\n` +
                    `å“åº”å¤´:\n` +
                    JSON.stringify(headers, null, 2), 
                    true);
            } catch (error) {
                showResult('preflight-result', 
                    `âŒ OPTIONS è¯·æ±‚å¤±è´¥ï¼š\n${error.message}`, 
                    false);
            }
        }

        // ä¸€é”®æµ‹è¯•æ‰€æœ‰
        async function testAll() {
            await testLogin();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testUserInfo();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testDeviceList();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testPreflight();
            
            alert('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹å„ä¸ªæµ‹è¯•ç»“æœã€‚');
        }
    </script>
</body>
</html>

