# é—®é¢˜ä¿®å¤æ€»ç»“ - Authorization è®¤è¯æœºåˆ¶

## ğŸ› åŸå§‹é—®é¢˜

**é”™è¯¯ä¿¡æ¯ï¼š**
```
Required request header 'Authorization' for method parameter type String is not present
```

**åŸå› ï¼š**
ç™»å½•æ¥å£ä¹Ÿè¦æ±‚ `Authorization` å¤´éƒ¨ï¼Œä½†ç”¨æˆ·è¿˜æ²¡ç™»å½•ï¼Œè‡ªç„¶æ²¡æœ‰ tokenã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

é‡‡ç”¨ **å…¨å±€å¼‚å¸¸å¤„ç† + å¿…å¡«å‚æ•°** çš„ç»„åˆæ–¹æ¡ˆï¼š

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é‡‡ç”¨ |
|------|------|------|------|
| æ–¹æ¡ˆAï¼šæ‰€æœ‰å‚æ•°è®¾ä¸ºå¯é€‰ `required=false` | ä¸æŠ¥é”™ | ä¸ç¬¦åˆè§„èŒƒï¼Œéœ€è¦æ‰‹åŠ¨åˆ¤æ–­ | âŒ |
| æ–¹æ¡ˆBï¼šä½¿ç”¨æ‹¦æˆªå™¨ç»Ÿä¸€å¤„ç† | é›†ä¸­ç®¡ç† | é…ç½®å¤æ‚ï¼Œéš¾ä»¥æ’é™¤ç‰¹å®šæ¥å£ | âŒ |
| **æ–¹æ¡ˆCï¼šå…¨å±€å¼‚å¸¸å¤„ç†å™¨** | ç®€æ´ã€ç¬¦åˆè§„èŒƒ | - | âœ… |

---

## ğŸ”§ å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šæ·»åŠ å…¨å±€å¼‚å¸¸å¤„ç†

åœ¨ `GlobalExceptionHandler.java` ä¸­æ·»åŠ ï¼š

```java
@ExceptionHandler(MissingRequestHeaderException.class)
public ApiResponse<Void> handleMissingRequestHeader(MissingRequestHeaderException e) {
    if ("Authorization".equals(e.getHeaderName())) {
        return ApiResponse.error(401, "è¯·å…ˆç™»å½•");
    }
    return ApiResponse.error(400, "ç¼ºå°‘å¿…éœ€çš„è¯·æ±‚å¤´: " + e.getHeaderName());
}
```

### æ­¥éª¤2ï¼šæ¢å¤å¿…å¡«å‚æ•°

æ‰€æœ‰éœ€è¦è®¤è¯çš„æ¥å£ï¼ŒAuthorization éƒ½æ˜¯å¿…å¡«ï¼š

```java
// âœ… æ­£ç¡®
@GetMapping("/info")
public ApiResponse<Map<String, Object>> getUserInfo(
        @RequestHeader("Authorization") String token) {
    // ...
}

// âŒ é”™è¯¯ï¼ˆä¹‹å‰çš„ä¸´æ—¶æ–¹æ¡ˆï¼‰
@GetMapping("/info")
public ApiResponse<Map<String, Object>> getUserInfo(
        @RequestHeader(value = "Authorization", required = false) String token) {
    if (token == null || token.isEmpty()) {
        return ApiResponse.error(401, "è¯·å…ˆç™»å½•");
    }
    // ...
}
```

### æ­¥éª¤3ï¼šç™»å½•æ¥å£ä¿æŒæ— éœ€è®¤è¯

```java
// âœ… ç™»å½•æ¥å£ä¸éœ€è¦ Authorization
@PostMapping("/login")
public ApiResponse<LoginResponse> login(@Valid @RequestBody LoginRequest request) {
    // æ— éœ€ @RequestHeader("Authorization")
}
```

---

## ğŸ“Š ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|------|----------|------|
| `GlobalExceptionHandler.java` | æ·»åŠ  `MissingRequestHeaderException` å¤„ç† | âœ… |
| `UserController.java` | Authorization æ”¹ä¸ºå¿…å¡« | âœ… |
| `DeviceController.java` | Authorization æ”¹ä¸ºå¿…å¡« | âœ… |
| `DeviceWarningController.java` | Authorization æ”¹ä¸ºå¿…å¡« | âœ… |

---

## ğŸ¯ æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šç™»å½•ï¼ˆæ— éœ€ tokenï¼‰

```bash
curl -X POST http://localhost:8080/user/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"123456"}'
```

**é¢„æœŸç»“æœï¼š** âœ… è¿”å› token
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "token": "eyJhbGci...",
    "user": {...}
  }
}
```

---

### æµ‹è¯•2ï¼šè®¿é—®å—ä¿æŠ¤æ¥å£ï¼ˆä¸å¸¦ tokenï¼‰

```bash
curl -X GET http://localhost:8080/user/info
```

**é¢„æœŸç»“æœï¼š** âœ… è¿”å›å‹å¥½é”™è¯¯
```json
{
  "code": 401,
  "msg": "è¯·å…ˆç™»å½•",
  "data": null
}
```

**è¯´æ˜ï¼š** å…¨å±€å¼‚å¸¸å¤„ç†å™¨è‡ªåŠ¨æ‹¦æˆª

---

### æµ‹è¯•3ï¼šè®¿é—®å—ä¿æŠ¤æ¥å£ï¼ˆå¸¦æœ‰æ•ˆ tokenï¼‰

```bash
curl -X GET http://localhost:8080/user/info \
  -H "Authorization: eyJhbGci..."
```

**é¢„æœŸç»“æœï¼š** âœ… è¿”å›ç”¨æˆ·ä¿¡æ¯
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "data": {
      "id": 1,
      "phone": "13800138000",
      "nikeName": "æµ‹è¯•ç”¨æˆ·"
    }
  }
}
```

---

## ğŸŒŸ ä¼˜åŠ¿æ€»ç»“

### 1. **ç¬¦åˆ RESTful è§„èŒƒ** âœ…
- å¿…å¡«å‚æ•°å°±åº”è¯¥æ˜¯å¿…å¡«çš„
- ä¸éœ€è¦åœ¨ä¸šåŠ¡é€»è¾‘ä¸­åˆ¤æ–­å‚æ•°å­˜åœ¨æ€§

### 2. **ä»£ç ç®€æ´** âœ…
- Controller å±‚ä»£ç æ›´ç®€æ´
- ä¸éœ€è¦é‡å¤çš„ `if (token == null)` åˆ¤æ–­

### 3. **ç»Ÿä¸€ç®¡ç†** âœ…
- å…¨å±€å¼‚å¸¸å¤„ç†å™¨ç»Ÿä¸€å¤„ç†
- ä¿®æ”¹ä¸€å¤„ï¼Œå…¨å±€ç”Ÿæ•ˆ

### 4. **å‹å¥½é”™è¯¯** âœ…
- è‡ªåŠ¨è¿”å› `401 è¯·å…ˆç™»å½•`
- å®¢æˆ·ç«¯èƒ½æ˜ç¡®çŸ¥é“é—®é¢˜

### 5. **æ˜“äºç»´æŠ¤** âœ…
- æ–°å¢æ¥å£è‡ªåŠ¨å—ä¿æŠ¤
- åªéœ€æ·»åŠ  `@RequestHeader("Authorization")`

---

## ğŸ“‹ å·¥ä½œæµç¨‹

### å®¢æˆ·ç«¯è¯·æ±‚æµç¨‹

```
1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚
   â†“
2. Spring MVC æ£€æŸ¥å¿…å¡«å‚æ•°
   â†“
3a. ç¼ºå°‘ Authorizationï¼Ÿ
    â†“ æ˜¯
    â†’ æŠ›å‡º MissingRequestHeaderException
    â†’ å…¨å±€å¼‚å¸¸å¤„ç†å™¨æ•è·
    â†’ è¿”å› {"code":401, "msg":"è¯·å…ˆç™»å½•"}
   â†“ å¦
3b. è¿›å…¥ Controller æ–¹æ³•
    â†“
4. è§£æ JWT Token
   â†“
5. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
   â†“
6. è¿”å›ç»“æœ
```

---

## ğŸ“ çŸ¥è¯†ç‚¹

### 1. Spring MVC å‚æ•°ç»‘å®š

```java
@RequestHeader("Authorization") String token
// é»˜è®¤ required = trueï¼ˆå¿…å¡«ï¼‰

@RequestHeader(value = "Authorization", required = false) String token
// è®¾ç½®ä¸ºå¯é€‰
```

### 2. å…¨å±€å¼‚å¸¸å¤„ç†å™¨

```java
@RestControllerAdvice  // å…¨å±€å¼‚å¸¸å¤„ç†
public class GlobalExceptionHandler {
    
    @ExceptionHandler(MissingRequestHeaderException.class)
    public ApiResponse<Void> handleMissingRequestHeader(...) {
        // æ•è·ç¼ºå°‘è¯·æ±‚å¤´çš„å¼‚å¸¸
    }
}
```

### 3. å¼‚å¸¸å¤„ç†ä¼˜å…ˆçº§

1. Controller å†…çš„ `@ExceptionHandler` ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. `@ControllerAdvice` æˆ– `@RestControllerAdvice`
3. Spring é»˜è®¤å¼‚å¸¸å¤„ç†

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- `Authorizationè®¤è¯æœºåˆ¶è¯´æ˜.md` - è¯¦ç»†çš„è®¤è¯æœºåˆ¶è¯´æ˜
- `ç™»å½•æµ‹è¯•æŒ‡å—.md` - æµ‹è¯•æ­¥éª¤
- `test_login.http` - HTTP æµ‹è¯•æ–‡ä»¶

---

## âœ… éªŒè¯æ¸…å•

- [x] ç™»å½•æ¥å£æ— éœ€ Authorization
- [x] å…¶ä»–æ¥å£å¿…é¡»æœ‰ Authorization
- [x] ç¼ºå°‘ Authorization æ—¶è¿”å›å‹å¥½é”™è¯¯
- [x] å…¨å±€å¼‚å¸¸å¤„ç†å™¨å·¥ä½œæ­£å¸¸
- [x] ä»£ç ç®€æ´ï¼Œæ— é‡å¤åˆ¤æ–­
- [x] æ‰€æœ‰æ–‡ä»¶æ—  linter é”™è¯¯

---

## ğŸ‰ é—®é¢˜è§£å†³ï¼

ç°åœ¨çš„å®ç°ï¼š
- âœ… **ç™»å½•æ¥å£** - ä¸éœ€è¦ Authorization
- âœ… **å…¶ä»–æ¥å£** - **å¿…é¡»**æœ‰ Authorizationï¼ˆå¼ºåˆ¶ï¼‰
- âœ… **å‹å¥½é”™è¯¯** - ç¼ºå°‘æ—¶è‡ªåŠ¨è¿”å› `401 è¯·å…ˆç™»å½•`
- âœ… **ä»£ç ç®€æ´** - æ— éœ€æ‰‹åŠ¨åˆ¤æ–­

**é‡å¯åç«¯æœåŠ¡å³å¯ç”Ÿæ•ˆï¼** ğŸš€

